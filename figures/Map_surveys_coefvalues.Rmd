---
title: "Map of Surveys with Coefficient Values and Classifications"
output: html_notebook
---

Here, I plan to make a global map showing how each survey region is classified (homogenization, differentiation, no significant change.)

```{r}
library(data.table)
library(ggplot2)
library(ggspatial) #basemap
library(rgdal)
library(sp)
library(rgeos)
library(viridis)
library(here)
library(maps)
library(mapproj)
library(concaveman)
library(dplyr)
library(purrr)
library(sf)

```

Pull in data
```{r pull in data}
region_stats <- readRDS(here::here("output","region_stats","region_stats.rds"))

#raw data
FishGlob_clean <- readRDS(here::here("data", "cleaned", "FishGlob.wellsampledyearscells_complete.final.rds"))

#Additional cleaning (first written in "dissim_metric_space_time.Rmd")*

#Delete observations without CPUE except for MEDITS (we will do trends in abundance metrics for this region)
FishGlob_clean.noNA <- FishGlob_clean[(survey != "MEDITS" & !is.na(wgt_cpue)) | survey == "MEDITS",]

FishGlob_clean.noNA <- copy(FishGlob_clean.noNA)[!is.infinite(wgt_cpue), ]

#combine with more helpful names

```

Key to combine with more helpful names
```{r}
name_helper <- data.table(Survey_Name_Season = c("Aleutian Islands",
                                    "Baltic Sea Q1",
                                    "Baltic Sea Q4",
                                    "Chile",
                                    "Newfoundland",
                                    "Queen Charlotte Sound",
                                    "Eastern Bering Sea",
                                    "Bay of Biscay",
                                    "English Channel",
                                    "Gulf of Mexico",
                                    "Gulf of Alaska",
                                    "Greenland",
                                    "N Gulf of St. Lawrence",
                                    "S Gulf of St. Lawrence",
                                    "Iceland",
                                    "Irish Sea",
                                    "Mediterranean",
                                    "Namibia",
                                    "NE US Fall",
                                    "NE US Spring",
                                    "N Ireland Q1",
                                    "N Ireland Q4",
                                    "Norway",
                                    "N Sea Q1",
                                    "N Sea Q3",
                                    "Chatham Rise",
                                    "E Coast S Island NZ",
                                    "W Coast S Island NZ",
                                    "Portugal",
                                    "S Georgia Straight",
                                  "Scotian Shelf",
                                  "SE US Fall",
                                  "SE US Spring",
                                  "SE US Summer",
                                  "W Coast US",
                                  "Atlantic Ocean ZA",
                                  "Indian Ocean ZA"),
                          survey_unit = c(
                                  "AI",        
                                  "BITS-1",    
                                  "BITS-4",    
                                  "CHL",       
                                  "DFO-NF",    
                                  "DFO-QCS",   
                                  "EBS",       
                                  "EVHOE",     
                                  "FR-CGFS",   
                                  "GMEX-Summer",
                                  "GOA",       
                                  "GRL-DE",    
                                  "GSL-N",     
                                  "GSL-S",     
                                  "ICE-GFS",   
                                  "IE-IGFS",   
                                  "MEDITS",    
                                  "NAM",       
                                  "NEUS-Fall", 
                                  "NEUS-Spring",
                                  "NIGFS-1",   
                                  "NIGFS-4",   
                                  "Nor-BTS-3", 
                                  "NS-IBTS-1", 
                                  "NS-IBTS-3", 
                                  "NZ-CHAT",   
                                  "NZ-ECSI",   
                                  "NZ-WCSI",   
                                  "PT-IBTS",   
                                  "S-GEORG",   
                                  "SCS-SUMMER",
                                  "SEUS-fall", 
                                  "SEUS-spring",
                                  "SEUS-summer",
                                  "WCANN",     
                                  "ZAF-ATL",   
                                  "ZAF-IND"   
                          ))
```


Unique lat lon values
```{r unique lat lon}
unique_lat_lon_survey_units <- unique(FishGlob_clean.noNA[,.(survey_unit, survey, latitude, longitude)])
#shift longitude for mapping
unique_lat_lon_survey_units[,longitude_s := ifelse(longitude >160, longitude - 360, longitude)]

unique_lat_lon_survey_units.spdf <- copy(unique_lat_lon_survey_units)
#alternative to make spdf
coordinates(unique_lat_lon_survey_units.spdf) <- c(5,3)

unique_lat_lon_survey_units.spdf$long <- unique_lat_lon_survey_units$longitude_s
unique_lat_lon_survey_units.spdf$lat <- unique_lat_lon_survey_units$latitude

```

Palette for plotting all 37 survey units
```{r link colors to survey units}
survey_unit.list <- levels(as.factor(FishGlob_clean.noNA[,survey_unit]))

palette_37 <- c(
  "#5A5156", #AI
  "#DF00DB", #BITS-1
  "#DB8EDA", #BITS-4
  "#F6222E", #CHL
  "#F8A19F", #DFO-NF
  "#16FF32", #DFO-QCS
  "#325A9B", #EBS
  "#3283FE", #EVHOE
  "#FEAF16", #FR-CGFS
  "#fccb6d", #GMEX-Fall
  "#1C8356", #GMEX-Summer
  "#C4451C", #GOA
  "#85660D", #GRL-DE
  "#B0009F", #GSL-N
  "#BF79B8", #GSL-S
  "#1CBE4F", #ICE-GFS
  "#782AB6", #IE-IGFS
  "#90AD1C", #MEDITS
  "#6B003A", #NAM
  "#A75B00", #NEUS-Fall
  "#E3B072", #NEUS-Spring
  "#02E8B6", #NIGFS-1
  "#97E7D5", #NIGFS-4
  "#B00068", #Nor-BTS-3
  "#00B9E3", #NS-IBTS-1
  "#95E2F4", #NS-IBTS-3
  "#B3CE73", #NZ-CHAT
  "#689500", #NZ-ECSI
  "#364d02",#NZ-SUBA
  "#AAF400", #NZ-WCSI
  "#AA0DFE", #PT-IBTS
  "#7f9eb8", #ROCKALL
  "#FA0087", #S-GEORG
  "#DEA0FD", #SCS-Summer
  "#FCEF88", #SEUS-fall
  "#A59405", #SEUS-spring
  "#FCE100", #SEUS-summer
  "#544563", #SWC-IBTS-1
  "#a37fc7", #SWC-IBTS-4
  "#C075A6", #WCANN
  "#BDCDFF", #ZAF-ATL
  "#003EFF"  #ZAF-IND
)

color_link <- data.table(survey_unit = survey_unit.list,hex = palette_37)
```

Base map
```{r}

t <- map_data("world2",wrap=c(-200,160), ylim=c(-60,90))

ggplot(t) + geom_polygon(aes(x = long, y = lat, group = group)) + coord_map()

```

Points and basemap
```{r}
basemap_points_color_survey_unit <- ggplot() +
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey") +
  geom_point(data = data.frame(unique_lat_lon_survey_units.spdf),
             aes(x = long, y = lat, group = survey_unit, color = survey_unit), size = 0.001, alpha = 0.8) +
  scale_color_manual(values = palette_37) +
  coord_map() +
  theme_classic() +
  theme(legend.position = "null")

basemap_points_color_survey_unit

ggsave(basemap_points_color_survey_unit, path = here::here("figures"), filename = "basemap_points_color_survey_unit.pdf", height = 10, width = 20, unit = "in")
```

Convert points to simple feature, and then use concaveman to make corresponding polygons
```{r points to simple feature}
all_survey_units_sf <- unique_lat_lon_survey_units %>%
          st_as_sf(coords = c("longitude_s","latitude"), crs = 4326)
```


```{r concaveman to make polygons}
#maybe consider changing #concavity and length threshold
all_survey_units_polygons <- purrr::map(unique(all_survey_units_sf$survey_unit),
                       ~ concaveman(all_survey_units_sf[all_survey_units_sf$survey_unit %in% .,], concavity = 1, length_threshold = 2)
                       ) %>%
  map2(unique(all_survey_units_sf$survey_unit), ~ mutate(.x, survey_unit = .y)) %>%
  reduce(rbind)

#world simple feature polygon to extract land from these polygons
world <- rnaturalearth::ne_countries(type = "countries", scale="large", returnclass="sf")

#delete areas where this polygon overlaps with land
all_survey_units_polygons.clean <- rmapshaper::ms_erase(all_survey_units_polygons,world[1])

#find polygon centroid
all_survey_units_centroid_points <- sf::st_centroid(all_survey_units_polygons.clean)

#plot_polygons with points
ggplot() +
  geom_sf(data = all_survey_units_polygons.clean, aes(fill = survey_unit), color = NA) +
  geom_sf(data = all_survey_units_centroid_points, aes(fill = survey_unit)) +
  scale_fill_manual(values = palette_37) +
  theme_classic()
```
Link with name helper
```{r}
all_survey_units_polygons.names <- left_join(all_survey_units_polygons.clean, name_helper, on = "survey_unit")
```


#Combine basemap and these regions
```{r combine basemap and survey regions}
(survey_unit_filled_polygons <- ggplot() +
  geom_sf(data = all_survey_units_polygons.names, aes(fill = reorder(Survey_Name_Season,survey_unit)), color = NA, alpha = 0.3) +
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey") +
  scale_fill_manual(values = palette_37) +
  coord_sf() +
  lims(x = c(-200,60)) +
  theme_classic() +
  theme(axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()))

ggsave(survey_unit_filled_polygons, path = here::here("figures"), filename = "survey_unit_filled_polygons.pdf", height =10, width = 18, unit = "in")

#polygon outlines only
(survey_unit_outline_polygons <- ggplot() +
  geom_sf(data = all_survey_units_polygons.names, aes(color = reorder(Survey_Name_Season,survey_unit)), fill = NA, alpha = 0.5, linewidth = 0.1) +
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey") +
  scale_color_manual(values = palette_37) +
  coord_sf() +
  lims(x = c(-200,60)) +
  theme_classic() +
  theme(axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()))

ggsave(survey_unit_outline_polygons, path = here::here("figures"), filename = "survey_unit_outline_polygons.pdf", height =10, width = 18, unit = "in")
```
Base theme (by Chris)
```{r}
# Base theme
base_theme <- theme(axis.text=element_text(size=7),
                    axis.text.y = element_text(angle = 90, hjust = 0.5),
                    axis.title=element_text(size=8),
                    legend.text=element_text(size=7),
                    legend.title=element_text(size=8),
                    plot.tag=element_text(size=9),
                    # Gridlines
                    panel.grid.major = element_blank(), 
                    panel.grid.minor = element_blank(),
                    panel.background = element_blank(), 
                    axis.line = element_line(colour = "black"),
                    # Legend
                    legend.background = element_rect(fill=alpha('blue', 0)))
```


Instead color by change experienced
```{r combine basemap and survey regions}
#merge polygons with stats
all_survey_units_polygons_stats <- left_join(all_survey_units_polygons.names, region_stats, on = "survey_unit")

#merge points with stats
all_survey_units_centroid_points_stats <- left_join(all_survey_units_centroid_points, region_stats, on = "survey_unit")


map_bray_coef_trend <- ggplot() +
    #world map
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey", color="white", lwd=0.1) +
  #polygons
  geom_sf(data = all_survey_units_polygons_stats, aes(fill = `Significant Trends`), alpha = 0.7) +
  #polygon outlines
  geom_sf(data = all_survey_units_polygons_stats, aes(color = `Significant Trends`), linewidth = 0.1, alpha = 1, lwd = 0.4, fill = NA) +
  geom_sf(st_jitter(all_survey_units_centroid_points_stats, 2), mapping = aes(fill = `Significant Trends`), size=1, pch=21, color="black", lwd = 0.1) +
  scale_fill_manual(values = c("#73BA4D","#E0962C","#cbbfde"),
                    labels = c("Differentiation","Homogenization","No trend in dissimilarity")) +
  scale_color_manual(values = c("#73BA4D","#E0962C","#cbbfde"),
                     labels = c("Differentiation","Homogenization","No trend in dissimilarity")) +
    # Labels
  scale_x_continuous(breaks=seq(-180, 50, 30)) +
  scale_y_continuous(breaks=seq(-90, 90, 30)) +
  labs(x = "Longitude",y = "Latitude") +
  # Crop
  coord_sf(y=c(-60,85), x=c(-200,40), expand = F) +
  lims(x = c(-200,60)) +
  guides(fill = guide_legend(title = "Dissimilarity trend"),
         color = guide_legend(title = "Dissimilarity trend")) +
  theme_bw() +
  base_theme +
    theme(legend.position = c(0.2, 0.4),
        legend.key.size = unit(0.6, "cm"))

map_bray_coef_trend

ggsave(map_bray_coef_trend, path = here::here("figures"), filename = "map_bray_coef_trend.pdf", height = 4, width = 8, unit = "in")
```
Merge completed map with visualizations of NMDS
```{r}
library(cowplot)

#load extra plots
mds_contrast <- readRDS(here::here("figures","mds_contrast.rds"))

merge_nmds_map <- plot_grid(
  map_bray_coef_trend,
  mds_contrast, 
  ncol = 1, nrow = 2, labels = c("a.","b."), label_size = 10, label_face = "bold",
  rel_heights = c(2,1)
)

ggsave(merge_nmds_map, path = here::here("figures"), filename = "merge_nmds_map.jpg", height = 7, width = 7, unit = "in")

```
















#############

Other maps, probably scratch, hasn't been updated
```{r other map possibilities}
#with points and polygon outlines
map_bray_coef_trend_withpoints <- ggplot() +
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey") +
  geom_point(data = unique_lat_lon_survey_units_stats, aes(x = longitude_s, y = latitude,color = `Significant Trends`),
             alpha = 0.8, size = 0.01) +
  scale_color_manual(values = c("#73BA4D","#E0962C","#cbbfde")) +
  geom_sf(data = all_survey_units_polygons_stats, fill = NA, color = "black", linewidth = 0.1) +
  coord_sf() +
  theme_classic() +
  lims(x = c(-200,60)) +
  guides(color = guide_legend(title = "Trend in Spatial\nDissimilarity",
                              override.aes = list(size=10))) +
  theme(axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())

map_bray_coef_trend_withpoints

ggsave(map_bray_coef_trend_withpoints, path = here::here("figures"), filename = "map_bray_coef_trend_withpoints.pdf", height = 10, width = 20, unit = "in")

library(ggnewscale)
#with points and COLORED polygon outlines
map_bray_coef_trend_withpoints_coloredpoly <- ggplot() +
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey") +
  geom_point(data = unique_lat_lon_survey_units_stats, aes(x = longitude_s, y = latitude,color = `Significant Trends`),
             alpha = 0.8, size = 0.01) +
  scale_color_manual(values = c("#73BA4D","#E0962C","#cbbfde")) +
  guides(color = guide_legend(title = "Trend in Spatial\nDissimilarity",
                              override.aes = list(size=10))) +
  new_scale_color() +
  geom_sf(data = all_survey_units_polygons_stats.names, aes(color = reorder(Survey_Name_Season,survey_unit)), fill = NA, alpha = 0.5, linewidth = 0.1) +
  scale_color_manual(values = palette_37) +
  coord_sf() +
  theme_classic() +
  lims(x = c(-200,60)) +
  guides(color = element_blank()) +
  theme(axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())

map_bray_coef_trend_withpoints_coloredpoly

ggsave(map_bray_coef_trend_withpoints_coloredpoly, path = here::here("figures"), filename = "map_bray_coef_trend_withpoints_coloredpoly.pdf", height = 9, width = 18, unit = "in")
```
