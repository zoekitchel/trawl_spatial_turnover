---
title: "Map of Surveys with Coefficient Values and Classifications"
output: html_notebook
---

Here, I plan to make a global map showing how each survey region is classified (homogenization, differentiation, no significant change.)

```{r}
library(data.table)
library(ggplot2)
library(ggspatial) #basemap
library(rgdal)
library(sp)
library(rgeos)
library(viridis)
library(here)
library(maps)
library(mapproj)
library(concaveman)
library(dplyr)
library(purrr)
library(sf)
library(ggpattern) #geom_polygon_pattern()?
#I have also experienced this issue, an st_cast to multipolygon instantly fixed the patterns from not showing.

```

Pull in data
```{r pull in data}
region_stats <- readRDS(here::here("output","region_stats","region_stats.rds"))

#raw data
FishGlob_clean <- readRDS(here::here("data", "cleaned", "FishGlob.wellsampledyearscells_complete.final.rds"))

#Additional cleaning (first written in "BC_total_dissim_metric_space_time.Rmd")*

#Delete observations without CPUE except for MEDITS (we will do trends in abundance metrics for this region)
FishGlob_clean.noNA <- FishGlob_clean[(survey != "MEDITS" & !is.na(wgt_cpue)) | survey == "MEDITS",]

FishGlob_clean.noNA <- copy(FishGlob_clean.noNA)[!is.infinite(wgt_cpue), ]

#combine with more helpful names

```

Key to combine with more helpful names
```{r}
name_helper <- data.table(Survey_Name_Season = c("Aleutian Islands",
                                    "Baltic Sea Q1",
                                    "Baltic Sea Q4",
                                    "Chile",
                                    "Newfoundland",
                                    "Queen Charlotte Sound",
                                    "Eastern Bering Sea",
                                    "Bay of Biscay",
                                    "English Channel",
                                    "Gulf of Mexico Summer",
                                    "Gulf of Alaska",
                                    "Greenland",
                                    "N Gulf of St. Lawrence",
                                    "S Gulf of St. Lawrence",
                                    "Iceland",
                                    "Irish Sea",
                                    "Mediterranean",
                                    "Namibia",
                                    "NE US Fall",
                                    "NE US Spring",
                                    "N Ireland Q1",
                                    "N Ireland Q4",
                                    "Barents Sea Norway Q3",
                                    "N Sea Q1",
                                    "N Sea Q3",
                                    "Chatham Rise NZ",
                                    "E Coast S Island NZ",
                                    "W Coast S Island NZ",
                                    "Portugal",
                                    "S Georgia",
                                  "Scotian Shelf Summer",
                                  "SE US Fall",
                                  "SE US Spring",
                                  "SE US Summer",
                                  "W Coast US",
                                  "Atlantic Ocean ZA",
                                  "Indian Ocean ZA",
                                   "Rockall Plateau",
                                  "Scotland Shelf Sea Q1",
                                  "Scotland Shelf Sea Q4",
                                  "Falkland Islands",
                                  "Gulf of Mexico Fall",
                                  "Barents Sea Norway Q1",
                                  "Sub-Arctic NZ",
                                  "Scotian Shelf Spring"),
                          survey_unit = c(
                                  "AI",        
                                  "BITS-1",    
                                  "BITS-4",    
                                  "CHL",       
                                  "DFO-NF",    
                                  "DFO-QCS",   
                                  "EBS",       
                                  "EVHOE",     
                                  "FR-CGFS",   
                                  "GMEX-Summer",
                                  "GOA",       
                                  "GRL-DE",    
                                  "GSL-N",     
                                  "GSL-S",     
                                  "ICE-GFS",   
                                  "IE-IGFS",   
                                  "MEDITS",    
                                  "NAM",       
                                  "NEUS-Fall", 
                                  "NEUS-Spring",
                                  "NIGFS-1",   
                                  "NIGFS-4",   
                                  "Nor-BTS-3", 
                                  "NS-IBTS-1", 
                                  "NS-IBTS-3", 
                                  "NZ-CHAT",   
                                  "NZ-ECSI",   
                                  "NZ-WCSI",   
                                  "PT-IBTS",   
                                  "S-GEORG",   
                                  "SCS-SUMMER",
                                  "SEUS-fall", 
                                  "SEUS-spring",
                                  "SEUS-summer",
                                  "WCANN",     
                                  "ZAF-ATL",   
                                  "ZAF-IND",
                                  "ROCKALL",
                                  "SWC-IBTS-1",
                                  "SWC-IBTS-4",
                                  "FALK",
                                  "GMEX-Fall",
                                  "Nor-BTS-1",
                                  "NZ-SUBA",
                                  "SCS-SPRING"
                          ))



```


Unique lat lon values
```{r unique lat lon}
unique_lat_lon_survey_units <- unique(FishGlob_clean.noNA[,.(survey_unit, survey, latitude, longitude)])
#shift longitude for mapping
unique_lat_lon_survey_units[,longitude_s := ifelse(longitude >160, longitude - 360, longitude)]

unique_lat_lon_survey_units.spdf <- copy(unique_lat_lon_survey_units)
#alternative to make spdf
coordinates(unique_lat_lon_survey_units.spdf) <- c(5,3)

unique_lat_lon_survey_units.spdf$long <- unique_lat_lon_survey_units$longitude_s
unique_lat_lon_survey_units.spdf$lat <- unique_lat_lon_survey_units$latitude

```

Palette for plotting all 42 survey units
```{r link colors to survey units}
survey_unit.list <- levels(as.factor(FishGlob_clean.noNA[,survey_unit]))

palette_42 <- c(
  "#5A5156", #AI
  "#DF00DB", #BITS-1
  "#DB8EDA", #BITS-4
  "#F6222E", #CHL
  "#F8A19F", #DFO-NF
  "#16FF32", #DFO-QCS
  "#325A9B", #EBS
  "#3283FE", #EVHOE
  "#FEAF16", #FR-CGFS
  "#fccb6d", #GMEX-Fall
  "#1C8356", #GMEX-Summer
  "#C4451C", #GOA
  "#85660D", #GRL-DE
  "#B0009F", #GSL-N
  "#BF79B8", #GSL-S
  "#1CBE4F", #ICE-GFS
  "#782AB6", #IE-IGFS
  "#90AD1C", #MEDITS
  "#6B003A", #NAM
  "#A75B00", #NEUS-Fall
  "#E3B072", #NEUS-Spring
  "#02E8B6", #NIGFS-1
  "#97E7D5", #NIGFS-4
  "#B00068", #Nor-BTS-3
  "#00B9E3", #NS-IBTS-1
  "#95E2F4", #NS-IBTS-3
  "#B3CE73", #NZ-CHAT
  "#689500", #NZ-ECSI
  "#364d02",#NZ-SUBA
  "#AAF400", #NZ-WCSI
  "#AA0DFE", #PT-IBTS
  "#7f9eb8", #ROCKALL
  "#FA0087", #S-GEORG
  "#DEA0FD", #SCS-Summer
  "#FCEF88", #SEUS-fall
  "#A59405", #SEUS-spring
  "#FCE100", #SEUS-summer
  "#544563", #SWC-IBTS-1
  "#a37fc7", #SWC-IBTS-4
  "#C075A6", #WCANN
  "#BDCDFF", #ZAF-ATL
  "#003EFF"  #ZAF-IND
)

color_link <- data.table(survey_unit = survey_unit.list,hex = palette_42)
```

Base map
```{r}

t <- map_data("world2",wrap=c(-200,160), ylim=c(-60,90))

ggplot(t) + geom_polygon(aes(x = long, y = lat, group = group)) + coord_map()

```

Points and basemap
```{r}
basemap_points_color_survey_unit <- ggplot() +
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey") +
  geom_point(data = data.frame(unique_lat_lon_survey_units.spdf),
             aes(x = long, y = lat, group = survey_unit, color = survey_unit), size = 0.001, alpha = 0.8) +
  scale_color_manual(values = palette_42) +
  coord_map() +
  theme_classic() +
  theme(legend.position = "null")

basemap_points_color_survey_unit

ggsave(basemap_points_color_survey_unit, path = here::here("figures"), filename = "basemap_points_color_survey_unit.pdf", height = 10, width = 20, unit = "in")
```

Convert points to simple feature, and then use concaveman to make corresponding polygons
```{r points to simple feature}
all_survey_units_sf <- unique_lat_lon_survey_units %>%
          st_as_sf(coords = c("longitude_s","latitude"), crs = 4326)
```


```{r concaveman to make polygons}
#maybe consider changing #concavity and length threshold
all_survey_units_polygons <- purrr::map(unique(all_survey_units_sf$survey_unit),
                       ~ concaveman(all_survey_units_sf[all_survey_units_sf$survey_unit %in% .,], concavity = 1, length_threshold = 2)
                       ) %>%
  map2(unique(all_survey_units_sf$survey_unit), ~ mutate(.x, survey_unit = .y)) %>%
  reduce(rbind)

#world simple feature polygon to extract land from these polygons
world <- rnaturalearth::ne_countries(type = "countries", scale="large", returnclass="sf")

#delete areas where this polygon overlaps with land
all_survey_units_polygons.clean <- rmapshaper::ms_erase(all_survey_units_polygons,world[1])

#find polygon centroid
all_survey_units_centroid_points <- sf::st_centroid(all_survey_units_polygons.clean)


#for all NZ points, convert longitudes
all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit %in% c("NZ-WCSI")]=st_point(c(171.4543-360, -41.7294))

all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit %in% c("NZ-ECSI")]=st_point(c(172.5993-360, -44.17959))

all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit %in% c("NZ-CHAT")]=st_point(c(178.9788-360, -43.58499))

all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit %in% c("NZ-SUBA")]=st_point(c(170.3432-360, -50.50603))

#for all seasonal repeats, move duplicates a bit up and down
#BITS
all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit == "BITS-4"]=st_point(c(15.98157, 57.6))

#NIGFS
all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit == "NIGFS-4"]=st_point(c(-4.910924, 55))

#NS-IBTS
all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit == "NS-IBTS-3"]=st_point(c(2.856672, 58.2))

#SWC-IBTS
all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit == "SWC-IBTS-4"]=st_point(c(-7.493093, 59.1))

#GMEX
all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit == "GMEX-Summer"]=st_point(c(-93.15577, 30))

#NEUS
all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit == "NEUS-Spring"]=st_point(c(-70.58172, 42.2))

#SEUS
all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit == "SEUS-summer"]=st_point(c(-78.27192, 32))

all_survey_units_centroid_points$geometry[all_survey_units_centroid_points$survey_unit == "SEUS-fall"]=st_point(c(-78.27192, 30.5))


#plot_polygons with points
ggplot() +
  geom_sf(data = all_survey_units_polygons.clean, aes(fill = survey_unit), color = NA) +
  geom_sf(data = all_survey_units_centroid_points, aes(fill = survey_unit)) +
  scale_fill_manual(values = palette_42) +
  theme_classic()
```

Link with name helper
```{r}
all_survey_units_polygons.names <- left_join(all_survey_units_polygons.clean, name_helper, on = "survey_unit")
```


#Combine basemap and these regions
```{r combine basemap and survey regions}
(survey_unit_filled_polygons <- ggplot() +
  geom_sf(data = all_survey_units_polygons.names, aes(fill = reorder(Survey_Name_Season,survey_unit)), color = NA, alpha = 0.3) +
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey") +
  scale_fill_manual(values = palette_42) +
  coord_sf() +
  lims(x = c(-200,60)) +
  theme_classic() +
  theme(axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()))

ggsave(survey_unit_filled_polygons, path = here::here("figures"), filename = "survey_unit_filled_polygons.pdf", height =10, width = 18, unit = "in")

#polygon outlines only
(survey_unit_outline_polygons <- ggplot() +
  geom_sf(data = all_survey_units_polygons.names, aes(color = reorder(Survey_Name_Season,survey_unit)), fill = NA, alpha = 0.5, linewidth = 0.1) +
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey") +
  scale_color_manual(values = palette_42) +
  coord_sf() +
  lims(x = c(-200,60)) +
  theme_classic() +
  theme(axis.text = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()))

ggsave(survey_unit_outline_polygons, path = here::here("figures"), filename = "survey_unit_outline_polygons.pdf", height =10, width = 18, unit = "in")
```

Base theme (by Chris)
```{r}
# Base theme
base_theme <- theme(axis.text=element_text(size=7),
                    axis.text.y = element_text(angle = 90, hjust = 0.5),
                    axis.title=element_text(size=8),
                    legend.text=element_text(size=7),
                    legend.title=element_text(size=8),
                    plot.tag=element_text(size=9),
                    # Gridlines
                    panel.grid.major = element_blank(), 
                    panel.grid.minor = element_blank(),
                    panel.background = element_blank(), 
                    axis.line = element_line(colour = "black"),
                    # Legend
                    legend.background = element_rect(fill=alpha('blue', 0)))
```


Instead color by change experienced
```{r combine basemap and survey regions}
#merge polygons with stats
all_survey_units_polygons_stats <- left_join(all_survey_units_polygons.names, region_stats, on = "survey_unit")

#merge points with stats
all_survey_units_centroid_points_stats <- left_join(all_survey_units_centroid_points, region_stats, on = "survey_unit")

#focal regions
centroids_focal <- all_survey_units_centroid_points_stats %>%
  filter(survey_unit == "NZ-WCSI" |survey_unit == "SEUS-summer"|survey_unit == "SCS-SUMMER") %>%
  mutate(labels = c("b.","d.","c.")) #add labels

#edit lat lon a bit to help with visualization
centroids_focal$geometry[centroids_focal$survey_unit == "NZ-WCSI"]=st_point(c(-192, -41))
centroids_focal$geometry[centroids_focal$survey_unit == "SEUS-summer"]=st_point(c(-73, 33))
centroids_focal$geometry[centroids_focal$survey_unit == "SCS-SUMMER"]=st_point(c(-60, 42))


map_bray_coef_trend <- ggplot() +
    #world map
  geom_polygon(data = t, aes(x = long, y = lat, group = group), fill = "lightgrey", color="white", lwd=0.1) +
  #polygons
  geom_sf(data = all_survey_units_polygons_stats, aes(fill = `Significant Trends`), alpha = 0.7) +
  #polygon outlines
  geom_sf(data = all_survey_units_polygons_stats, aes(color = `Significant Trends`), linewidth = 0.1, alpha = 1, lwd = 0.4, fill = NA) +
  #colored points with trend assocaited with each survey
  geom_sf(all_survey_units_centroid_points_stats, mapping = aes(fill = `Significant Trends`), size=1, pch=21, color="black", lwd = 0.1) +
 # geom_sf_text(data = all_survey_units_centroid_points_stats, aes(label = survey_unit), size = 0.5) +
  scale_fill_manual(values = c("#73BA4D","#E0962C","#cbbfde"),
                    labels = c("Differentiation","Homogenization","No trend in dissimilarity")) +
  scale_color_manual(values = c("#73BA4D","#E0962C","#cbbfde"),
                     labels = c("Differentiation","Homogenization","No trend in dissimilarity")) +
    # Labels
  scale_x_continuous(breaks=seq(-180, 50, 30)) +
  scale_y_continuous(breaks=seq(-90, 90, 30)) +
  labs(x = "Longitude",y = "Latitude") +
  #Annotate b,c,d from lower panel (b = W coast south island NZ, c = Southeast US Summer, d = Scotian Shelf Canada)
  geom_sf_text(centroids_focal, mapping = aes(label = labels, fontface = "bold"), size = 3) +
  # Crop
  coord_sf(y=c(-60,85), x=c(-200,40), expand = F) +
  lims(x = c(-200,60)) +
  guides(fill = guide_legend(title = "Dissimilarity trend"),
         color = guide_legend(title = "Dissimilarity trend")) +
  theme_bw() +
  base_theme +
    theme(legend.position = c(0.2, 0.4),
        legend.key.size = unit(0.6, "cm"),
        legend.text = element_text(size = 12), legend.title = element_text(size = 12),
        axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())

map_bray_coef_trend

ggsave(map_bray_coef_trend, path = here::here("figures"), filename = "map_bray_coef_trend.pdf", height = 4, width = 8, unit = "in")
```

Merge completed map with visualizations of NMDS
```{r}
library(cowplot)

#load extra plots
mds_contrast <- readRDS(here::here("figures","mds_contrast.rds"))

merge_nmds_map <- plot_grid(
  map_bray_coef_trend,
  mds_contrast + theme(plot.margin = unit(c(0,1,0,0), "cm")), 
  ncol = 1, nrow = 2, labels = c("a.",""), label_size = 12, label_face = "bold",
  rel_heights = c(2,1)
)

ggsave(merge_nmds_map, path = here::here("figures"), filename = "merge_nmds_map.jpg", height = 7, width = 7, unit = "in")

```
