---
title: "Annual Balanced BC Dissimilarity vs. SODA Temperature for all Survey Units"
output: html_notebook
---

This code is Script X for Kitchel et al. TITLE manuscript.

- This project is a collaborative effort to describe changes in taxonomic composition  of fish communities around the world--as sampled by bottom trawl surveys.

- Code by Zoë J. Kitchel

SESSION INFO TO DO

##Here, we try to use temperature to predict annual dissimilarity for all survey units

```{r setup}

library(data.table)
library(ggplot2)
library(lme4)
library(lmerTest)
library(MuMIn)


SODA_data_temp_avgs_full <- readRDS(here::here("data","Temperature","SODA_data_temp_avgs_full.rds"))
#don't feel confident about SODA temp before 1980 right now, start then

SODA_data_temp_avgs_full <- SODA_data_temp_avgs_full[year_for_avg >= 1980,]

SODA_data_temp_avgs_full[,year := year_for_avg]

#pull in average distance decay values
distances_dissimilarities_allyears.r <- readRDS(here::here("output","distance_decay","distances_dissimilarities_allyears.r.rds"))

```

Put into one data table
```{r link temp to avg values}
dissimilarities_temp <- SODA_data_temp_avgs_full[distances_dissimilarities_allyears.r, on = c("year","survey_unit")]
```

Color pallete for survey units
```{r}
pal_37 <- c(
  "#5A5156", #AI
  "#F6222E", #CHL
  "#F8A19F", #DFO-NF
  "#16FF32", #DFO-QCS
  "#DF00DB", #BITS-1
  "#DB8EDA", #BITS-4
  "#325A9B", #EBS
  "#3283FE", #EVHOE
  "#FEAF16", #FR-CGFS
  "#1C8356", #GMEX-Summer
  "#C4451C", #GOA
  "#85660D", #GRL-DE
  "#B0009F", #GSL-N
  "#BF79B8", #GSL-S
  "#1CBE4F", #ICE-GFS
  "#782AB6", #IE-IGFS
  "#90AD1C", #MEDITS
  "#6B003A", #NAM
  "#A75B00", #NEUS-Fall
  "#E3B072", #NEUS-Spring
  "#02E8B6", #NIGFS-1
  "#97E7D5", #NIGFS-4
  "#B00068", #Nor-BTS-3
  "#00B9E3", #NS-IBTS-1
  "#95E2F4", #NS-IBTS-3
  "#B3CE73", #NZ-CHAT
  "#689500", #NZ-ECSI
  "#AAF400", #NZ-WCSI
  "#AA0DFE", #PT-IBTS
  "#FA0087", #S-GEORG
  "#DEA0FD", #SCS-Summer
  "#FCEF88", #SEUS-fall
  "#A59405", #SEUS-spring
  "#FCE100", #SEUS-summer
  "#C075A6", #WCANN
  "#BDCDFF", #ZAF-ATL
  "#003EFF")  #ZAF-IND
```

Table that will be populated with model results
```{r}
#depth, scaled, temp var, coefficient, p-value, marg_r^2, cond_r^2, AICc
balanced_dissimilarity_sbt_model_results <- data.table(Depth = as.character(),
                                                       Scaled = as.character(),
                                                       `Temp variable` = as.character(),
                                                       Intercept = as.numeric(),
                                                       `Temp coefficient` = as.numeric(),
                                                       `Coefficient p-value` = as.numeric(),
                                                       `Marginal R-squared` = as.numeric(),
                                                       `Conditional R-squared` = as.numeric(),
                                                       AICc = as.numeric(),
                                                       `Degrees of freedom`=as.numeric())
                                                  
```


How does this trend hold up for all regions?
###UNSCALED

####Mean temperature
```{r mean sbt}
#for all regions
(dissimilarity_BC_balanced_sbt_mean <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_mean, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_mean.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_mean_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_mean_facet, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_mean_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sbt_mean_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_avg + (1 + yearly_mean_bypoint_avg|survey_unit), data = dissimilarities_temp) #this converges (allows both intercept and slope to vary with survey_unit)

summary(dissimilarity_BC_balanced_sbt_mean_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_mean_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_mean_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 F, #scaled
                                                 "mean", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_mean_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_mean_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_mean_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_mean_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_mean_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)
```

####Min temperature
```{r min sbt}
#for all regions
(dissimilarity_BC_balanced_sbt_min <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_min, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_min.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_min_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_min_facet, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_min_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sbt_min_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_avg + (1 + yearly_min_bypoint_avg|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_min_mod) #insignificant relationship


confint <- confint(dissimilarity_BC_balanced_sbt_min_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_min_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 F, #scaled
                                                 "min", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_min_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_min_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_min_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_min_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_min_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)
```

####Max sbt
```{r max sbt}
#for all regions
(dissimilarity_BC_balanced_sbt_max <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_max, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_max.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_max_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_max_facet, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_max_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sbt_max_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_avg + (1 + yearly_max_bypoint_avg|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_max_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_max_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_max_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 F, #scaled
                                                 "max", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_max_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_max_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_max_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_max_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_max_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)

```

####Seas sbt
```{r seas sbt}
#for all regions
(dissimilarity_BC_balanced_sbt_seas <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_seas, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_seas.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_seas_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_seas_facet, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_seas_facet.jpg", height = 10, width = 11, unit = "in")


dissimilarity_BC_balanced_sbt_seas_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_avg + (1 + yearly_seas_bypoint_avg|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_seas_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_seas_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_seas_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 F, #scaled
                                                 "seas", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_seas_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_seas_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_seas_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_seas_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_seas_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)

```

###Standard deviation of grid cells
####Mean temperature SD
```{r mean sbt SD}
#for all regions
(dissimilarity_BC_balanced_sbt_meanSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean bottom temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_meanSD, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_meanSD.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_meanSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean bottom temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_meanSD_facet, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_meanSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sbt_meanSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_SD + (1 + yearly_mean_bypoint_SD|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_meanSD_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_meanSD_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_meanSD_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 F, #scaled
                                                 "meanSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_meanSD_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_meanSD_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_meanSD_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_meanSD_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_meanSD_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)


```

####Min temperature SD
```{r min sbt SD}
#for all regions
(dissimilarity_BC_balanced_sbt_minSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min bottom temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_minSD, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_minSD.jpg", height = 4, width = 9, unit = "in") 

#faceted
dissimilarity_BC_balanced_sbt_minSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min bottom temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_minSD_facet, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_minSD_facet.jpg", height = 10, width = 11, unit = "in")


dissimilarity_BC_balanced_sbt_minSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_SD + (1 + yearly_min_bypoint_SD|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_minSD_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_minSD_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_minSD_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 F, #scaled
                                                 "minSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_minSD_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_minSD_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_minSD_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_minSD_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_minSD_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)
```

####Max sbt SD
```{r max sbt SD}
#for all regions
dissimilarity_BC_balanced_sbt_maxSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max bottom temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_maxSD, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_maxSD.jpg", height = 4, width = 9, unit = "in") 

#faceted
dissimilarity_BC_balanced_sbt_maxSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max bottom temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_maxSD_facet, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_maxSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sbt_maxSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_SD + (1 + yearly_max_bypoint_SD|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_maxSD_mod) #significant relationship (0.02)

confint <- confint(dissimilarity_BC_balanced_sbt_maxSD_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_maxSD_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 F, #scaled
                                                 "maxSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_maxSD_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_maxSD_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_maxSD_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_maxSD_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_maxSD_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)

```

####Seas sbt SD
```{r seas sbt SD}
#for all regions
(dissimilarity_BC_balanced_sbt_seasSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of bottom temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_seasSD, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_seasSD.jpg", height = 4, width = 9, unit = "in")

#faceted
dissimilarity_BC_balanced_sbt_seasSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of bottom temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_seasSD_facet, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_seasSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sbt_seasSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_SD + (1 + yearly_seas_bypoint_SD|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_seasSD_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_seasSD_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_seasSD_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 F, #scaled
                                                 "seasSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_seasSD_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_seasSD_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_seasSD_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_seasSD_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_seasSD_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)



```


###Raw temp values: Comparing temperature predictors for raw
```{r compare raw temp predictors}

setorder(balanced_dissimilarity_sbt_model_results,AICc)
balanced_dissimilarity_sbt_model_results


```
The raw mean temperature in the 12 months before a survey is the best predictor.

As the raw mean temp 12 months before a survey increases, the dissimilarity also increases (0.004 * ˚C). Warmer ecosystems are more heterogenous in community structure.

---
##SCALED
###Avg of grid cells
####Mean temperature scaled
```{r mean sbt scaled}
#for all regions
dissimilarity_BC_balanced_sbt_mean_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean bottom temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_mean_scaled, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_mean_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_mean_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_avg.s + (1 + yearly_mean_bypoint_avg.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_mean_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_mean_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_mean_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 T, #scaled
                                                 "mean", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_mean_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_mean_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_mean_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_mean_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_mean_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)
```

####Min temperature scaled
```{r min sbt scaled}
#for all regions
dissimilarity_BC_balanced_sbt_min_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min bottom temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_min_scaled, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_min_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_min_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_avg.s + (1 + yearly_min_bypoint_avg.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_min_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_min_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_min_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 T, #scaled
                                                 "min", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_min_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_min_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_min_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_min_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_min_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)
```

####Max sbt scaled
```{r max sbt scaled}
#for all regions
dissimilarity_BC_balanced_sbt_max_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max bottom temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_max_scaled, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_max_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_max_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_avg.s + (1 + yearly_max_bypoint_avg.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_max_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_max_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_max_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 T, #scaled
                                                 "max", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_max_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_max_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_max_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_max_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_max_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)

```

####Seas sbt scaled
```{r seas sbt scaled}
#for all regions
dissimilarity_BC_balanced_sbt_seas_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of bottom temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_seas_scaled, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_seas_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_seas_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_avg.s + (1 + yearly_seas_bypoint_avg.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_seas_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_seas_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_seas_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 T, #scaled
                                                 "seas", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_seas_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_seas_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_seas_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_seas_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_seas_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)

```
###Standard deviation of grid cells
####Mean temperature SD scaled
```{r mean sbt SD scaled}
#for all regions
(dissimilarity_BC_balanced_sbt_meanSD_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean bottom temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_meanSD_scaled, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_meanSD_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_meanSD_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_SD.s + (1 + yearly_mean_bypoint_SD.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_meanSD_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_meanSD_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_meanSD_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 T, #scaled
                                                 "meanSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_meanSD_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_meanSD_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_meanSD_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_meanSD_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_meanSD_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)
```

####Min temperature SD scaled
```{r min sbt SD scaled}
#for all regions
dissimilarity_BC_balanced_sbt_minSD_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min bottom temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_minSD_scaled, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_minSD_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_minSD_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_SD.s + (1 + yearly_min_bypoint_SD.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_minSD_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_minSD_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_minSD_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 T, #scaled
                                                 "minSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_minSD_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_minSD_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_minSD_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_minSD_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_minSD_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)
```

####Max sbt SD scaled
```{r max sbt SD scaled}
#for all regions
dissimilarity_BC_balanced_sbt_maxSD_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max bottom temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_maxSD_scaled, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_maxSD_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_maxSD_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_SD.s + (1 + yearly_max_bypoint_SD.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_maxSD_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_maxSD_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_maxSD_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 T, #scaled
                                                 "maxSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_maxSD_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_maxSD_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_maxSD_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_maxSD_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_maxSD_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)

```

####Seas sbt SD scaled
```{r seas sbt SD scaled}
#for all regions
dissimilarity_BC_balanced_sbt_seasSD_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of bottom temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(pal_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sbt_seasSD_scaled, path  = here::here("figures","distance_decay"), filename = "dissimilarity_BC_balanced_sbt_seasSD_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_seasSD_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_SD.s + (1 + yearly_seas_bypoint_SD.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sbt_seasSD_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sbt_seasSD_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sbt_seasSD_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sbt_model_results_row <- data.table(matrix(c("sbt", #depth
                                                 T, #scaled
                                                 "seasSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_seasSD_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sbt_seasSD_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_seasSD_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sbt_seasSD_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sbt_seasSD_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sbt_model_results <- rbind(balanced_dissimilarity_sbt_model_results,balanced_dissimilarity_sbt_model_results_row, use.names = F)

```



###Comparing scaled temperature predictors
```{r compare scaled temp predictors}

balanced_dissimilarity_sbt_model_results[Scaled == T,]



#for all temp mods, almost nothing is described by scaled temp in region (0.05% of variation), most described by survey unit (90% of variation)
```
Relative mean temperature for the 12 months before survey is the best predictor. As temp increases, dissimilarity increases. Relatively warm years are more heterogenous. 

####What to carry forward:
Best models
```{r}
balanced_dissimilarity_sbt_model_results

saveRDS(balanced_dissimilarity_sbt_model_results, here::here("output","balanced_dissimilarity_sbt_model_results.rds"))
```

For both scaled and unscaled, mean temp is the best predictor.

####Finally, plot two best models
Raw: dissimilarity_BC_balanced_sbt_meanSD_mod and dissimilarity_BC_balanced_sbt_mean_mod essentially tied, we'll just plot mean

####Finally, plot two best models
Raw: dissimilarity_BC_balanced_sbt_mean_mod
```{r}
dissimilarities_temp.nona <- na.omit(dissimilarities_temp)

dissimilarities_temp.nona$pred_mean_sbt <- predict(dissimilarity_BC_balanced_sbt_mean_mod,re.form=NA)  ## population level
dissimilarities_temp.nona$pred_mean_sbt_individual <- predict(dissimilarity_BC_balanced_sbt_mean_mod) ## individual level

#confidence intervals
confit <- confint(dissimilarity_BC_balanced_sbt_mean_scaled_mod, oldNames = F)

#upper lower bounds from confidence intervals
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_lwr := confit[5,1] + confit[6,1]*yearly_mean_bypoint_avg]#lower confidence interval
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_upr := confit[5,2] + confit[6,2]*yearly_mean_bypoint_avg]#upper confidence interval


#for all regions
(dissimilarity_BC_balanced_sbt_mean.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = as.numeric(yearly_mean_bypoint_avg), y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = as.numeric(yearly_mean_bypoint_avg), y = pred_mean_sbt_individual, color = survey_unit)) +
  scale_color_manual(values = c(pal_37)) +
  geom_line(aes(x = as.numeric(yearly_mean_bypoint_avg), y = pred_mean_sbt), color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_mean.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean.final.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_mean_facet.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = pred_mean_sbt_individual, color = survey_unit)) +
  scale_color_manual(values = c(pal_37)) +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic() +
  theme(legend.position = "null")


ggsave(dissimilarity_BC_balanced_sbt_mean_facet.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean_facet.final.jpg", height = 10, width = 16, unit = "in")

#simplified color scheme
(dissimilarity_BC_balanced_sbt_mean.finalSIMPLIFIED <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean bottom temperature (˚C)",  y = "Dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.4) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = pred_mean_sbt), color  = "black") +
    geom_ribbon(aes(x = yearly_mean_bypoint_avg, ymin = pred_mean_temp_scale_byreg_lwr, ymax = pred_mean_temp_scale_byreg_upr), alpha = 0.3) +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_mean.finalSIMPLIFIED, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean.finalSIMPLIFIED.jpg", height = 4, width = 9, unit = "in") 
```


Scaled: dissimilarity_BC_balanced_sbt_mean_scaled_mod
```{r}
dissimilarities_temp.nona$pred_mean_sbt.s <- predict(dissimilarity_BC_balanced_sbt_mean_scaled_mod,re.form=NA)  ## population level
dissimilarities_temp.nona$pred_mean_sbt_individual.s <- predict(dissimilarity_BC_balanced_sbt_mean_scaled_mod) ## individual level


#confidence intervals
confit <- confint(dissimilarity_BC_balanced_sbt_mean_scaled_mod, oldNames = F)

#upper lower bounds from confidence intervals
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_lwr := confit[5,1] + confit[6,1]*yearly_mean_bypoint_avg.s]#lower confidence interval
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_upr := confit[5,2] + confit[6,2]*yearly_mean_bypoint_avg.s]#upper confidence interval

#for all regions
(dissimilarity_BC_balanced_sbt_mean.s.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Relative mean bottom temperature",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = pred_mean_sbt_individual.s, color = survey_unit)) +
  scale_color_manual(values = c(pal_37)) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = pred_mean_sbt.s), color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_mean.s.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean.s.final.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_mean_facet.s.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Relative mean bottom temperature",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = pred_mean_sbt_individual.s, color = survey_unit)) +
  scale_color_manual(values = c(pal_37)) +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic() +
  theme(legend.position = "null")

ggsave(dissimilarity_BC_balanced_sbt_mean_facet.s.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean_facet.s.final.jpg", height = 10, width = 16, unit = "in")

#simplified color scheme
(dissimilarity_BC_balanced_sbt_mean.s.final.SIMPLIFIED <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Relative mean bottom temperature",  y = "Dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.4) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = pred_mean_sbt.s), color  = "black") +
    geom_ribbon(aes(x = yearly_mean_bypoint_avg.s, ymin = pred_mean_temp_scale_byreg_lwr, ymax = pred_mean_temp_scale_byreg_upr), alpha = 0.3) +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_mean.s.final.SIMPLIFIED, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean.s.final.SIMPLIFIED.jpg", height = 4, width = 9, unit = "in") 
```


####Finally, plot two best models
Raw: dissimilarity_BC_balanced_sbt_mean_mod
```{r}
dissimilarities_temp.nona <- na.omit(dissimilarities_temp)

dissimilarities_temp.nona$pred_mean_sbt <- predict(dissimilarity_BC_balanced_sbt_mean_mod,re.form=NA)  ## population level
dissimilarities_temp.nona$pred_mean_sbt_individual <- predict(dissimilarity_BC_balanced_sbt_mean_mod) ## individual level

#confidence intervals
confit <- confint(dissimilarity_BC_balanced_sbt_mean_scaled_mod, oldNames = F)

#upper lower bounds from confidence intervals
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_lwr := confit[5,1] + confit[6,1]*yearly_mean_bypoint_avg]#lower confidence interval
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_upr := confit[5,2] + confit[6,2]*yearly_mean_bypoint_avg]#upper confidence interval


#for all regions
(dissimilarity_BC_balanced_sbt_mean.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = as.numeric(yearly_mean_bypoint_avg), y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = as.numeric(yearly_mean_bypoint_avg), y = pred_mean_sbt_individual, color = survey_unit)) +
  scale_color_manual(values = c(pal_37)) +
  geom_line(aes(x = as.numeric(yearly_mean_bypoint_avg), y = pred_mean_sbt), color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_mean.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean.final.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sbt_mean_facet.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean bottom temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = pred_mean_sbt_individual, color = survey_unit)) +
  scale_color_manual(values = c(pal_37)) +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic() +
  theme(legend.position = "null")


ggsave(dissimilarity_BC_balanced_sbt_mean_facet.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean_facet.final.jpg", height = 10, width = 16, unit = "in")

#simplified color scheme
(dissimilarity_BC_balanced_sbt_mean.finalSIMPLIFIED <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean bottom temperature (˚C)",  y = "Dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.4) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = pred_mean_sbt), color  = "black") +
    geom_ribbon(aes(x = yearly_mean_bypoint_avg, ymin = pred_mean_temp_scale_byreg_lwr, ymax = pred_mean_temp_scale_byreg_upr), alpha = 0.3) +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sbt_mean.finalSIMPLIFIED, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean.finalSIMPLIFIED.jpg", height = 4, width = 9, unit = "in") 
```

Merge
```{r}
library(cowplot)
(dissimilarity_BC_balanced_sbt_mean.final.SIMPLIFIED_merge <- plot_grid(dissimilarity_BC_balanced_sbt_mean.finalSIMPLIFIED, dissimilarity_BC_balanced_sbt_mean.s.final.SIMPLIFIED + theme(axis.title.y = element_blank(), axis.text.y = element_blank()), nrow = 1, ncol = 2, labels = c("a.","b."), hjust = -1))

ggsave(dissimilarity_BC_balanced_sbt_mean.final.SIMPLIFIED_merge, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sbt_mean.final.SIMPLIFIED_merge.jpg", height = 4, width = 9, unit = "in") 
```