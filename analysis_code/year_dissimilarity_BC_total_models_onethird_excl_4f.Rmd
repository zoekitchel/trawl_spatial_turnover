---
title: "Dissimilarity time series analysis excluding species present in less than 1/3 of years"
author: Zoë J. Kitchel
date: October 17, 2023
output: html_notebook
---

Script 4f for Kitchel et al. 2023 in prep taxonomic diversity manuscript.

```{r setup}
library(data.table)
library(vegan)
library(sf)
library(concaveman) #polygon around points
library(betapart) #allows us to partition beta diversity
library(geosphere)
library(ggpubr) #stat_regline_equation
library(nlme)
library(mgcv) #to make gam
library(cowplot)
library(lme4)
library(stringr)
```

Pull dissimilarity table
```{r pull outputs from previous scripts}
#Pull Dissimilarity Means
distances_dissimilarities_allyears_onethirdyears_excluded <- readRDS(here::here("output","dissimilarities", "distances_dissimilarities_allyears_onethirdyears_excluded.rds"))

#make survey and survey unit factors
distances_dissimilarities_allyears_onethirdyears_excluded[,survey:=factor(survey)][,survey_unit:=factor(survey_unit)]

#adjust years
distances_dissimilarities_allyears_onethirdyears_excluded[,year_adj := year-min(year)+1]

#add new variable for year in sequence per region
distances_dissimilarities_allyears_onethirdyears_excluded[,first_year := min(year),.(survey_unit)]
distances_dissimilarities_allyears_onethirdyears_excluded[,last_year := max(year),.(survey_unit)]

#distances_dissimilarities_allyears_onethirdyears_excluded[,year_in_seq := year-first_year+1]

distances_dissimilarities_allyears_onethirdyears_excluded[,years_sampled := last_year-first_year+1]

#list of surveys
survey_unit.list <- levels(factor(distances_dissimilarities_allyears_onethirdyears_excluded$survey_unit))


```
 
 Pull in palette and name helper
```{r}
source(here::here("analysis_code","color_links.R"))
```


##Make GAM (Generalized Additive Models)

Bray Curtis
```{r bray curtis gams}
bray_curtis_total_gam <- gam(bray_curtis_dissimilarity_total_mean ~ year + s(survey_unit, year, bs = "fs", m = 1),#random smooth
                            data = distances_dissimilarities_allyears_onethirdyears_excluded)

```


##Make LMERS

Bray
*These all converged*
```{r bray}
#running with lme instead of lmer gave same results, but allowed for calculation of p-value
bray_curtis_total_lme <- lme(bray_curtis_dissimilarity_total_mean ~ year_adj, random = (~1 + year_adj|survey_unit),data = distances_dissimilarities_allyears_onethirdyears_excluded)

#but also run with lmer for confint
#total
bray_curtis_total_lmer <- lmer(bray_curtis_dissimilarity_total_mean ~ year_adj + (1 + year_adj|survey_unit),data = distances_dissimilarities_allyears_onethirdyears_excluded)


summary(bray_curtis_total_lme)
anova(bray_curtis_total_lme)

bray_curtis_total_coefs <- data.table(coef(bray_curtis_total_lme))
bray_curtis_total_coefs[,survey_unit := rownames(coef(bray_curtis_total_lme))][,Year := round(year_adj,5)][,Intercept := round(`(Intercept)`,2)]
#View(bray_curtis_total_coefs)

bray_curtis_total_coefs <- bray_curtis_total_coefs[color_link, on = "survey_unit"]

bray_curtis_total_coefs.exp <- bray_curtis_total_coefs[,.(Survey_Name_Season, Intercept, Year)]

#export this table
fwrite(bray_curtis_total_coefs.exp, file = here::here("output","bray_curtis_total_coefs.exp.csv"))
```
##Linear Model

Also, build a simple linear model with an interaction (instead of random slope and intercept for survey)
THIS IS HOW WE CLASSIFY SURVEYS as of fall 2023 (update from before, where we classified surveys from LMER)
```{r linear model Bray}

bray_curtis_total_lm <- lm(bray_curtis_dissimilarity_total_mean ~ year * survey_unit,data = distances_dissimilarities_allyears_onethirdyears_excluded)

bray_curtis_total_coefs <- data.table(summary(bray_curtis_total_lm)$coefficients)
  bray_curtis_total_coefs[,var := rownames(summary(bray_curtis_total_lm)$coefficients)]
  
  #limit to interactions only (check this if there are any model changes!) row 2 and rows 44:84
  bray_curtis_total_coefs_onethirdyears_exclude.r <- bray_curtis_total_coefs[c(2,44:84),]
  
  #adjust survey unit name by deleting beginning of string
  bray_curtis_total_coefs_onethirdyears_exclude.r[,survey_unit := substr(var, 17, str_length(var))][var == "year",survey_unit := "AI"]
  
  #calculate interaction coefficients
  AI_estimate <- bray_curtis_total_coefs_onethirdyears_exclude.r[1,Estimate]
  bray_curtis_total_coefs_onethirdyears_exclude.r[1,survey_unit_coefficient := AI_estimate]
  bray_curtis_total_coefs_onethirdyears_exclude.r[2:42,survey_unit_coefficient := (AI_estimate + Estimate)]
  
  #homogenizing vs differentiating
  bray_curtis_total_coefs_onethirdyears_exclude.r[,differentiating := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient > 0),1,0)][,homogenizing := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient < 0),1,0)]
  
  #lower and upper CI
    bray_curtis_total_coefs_onethirdyears_exclude.r[,lwr := survey_unit_coefficient-`Std. Error`][,upr:= survey_unit_coefficient+`Std. Error`]
    
    #save as output
    fwrite(bray_curtis_total_coefs_onethirdyears_exclude.r, here::here("output","bray_curtis_total_coefs_onethirdyears_exclude.r.csv"))
  
  bray_curtis_total_coefs_sum <- data.table(differentiating = sum(  bray_curtis_total_coefs_onethirdyears_exclude.r$differentiating), homogenizing = sum(  bray_curtis_total_coefs_onethirdyears_exclude.r$homogenizing))
  
  #hex by trend
  bray_curtis_total_coefs_onethirdyears_exclude.r[,trend_color := ifelse(homogenizing == 1, "#e7ac5b", ifelse(differentiating == 1,"#91c874","#cbbfde"))]
  
  #link to color link
  bray_curtis_total_coefs_onethirdyears_exclude.r <- color_link[bray_curtis_total_coefs_onethirdyears_exclude.r, on = "survey_unit"]
  
  color_link_trend <- bray_curtis_total_coefs_onethirdyears_exclude.r[,.(survey_unit,Survey_Name_Season, hex,  trend_color)]

```

Get LMER model as predictions
```{r TOTAL BC}

# need to sort out year in seq versus overall year models
#new data for lmer
lmer_year <- seq(min(distances_dissimilarities_allyears_onethirdyears_excluded[,year]), max(distances_dissimilarities_allyears_onethirdyears_excluded[,year]), by = 0.1)

lmer_year_adj <- seq(min(distances_dissimilarities_allyears_onethirdyears_excluded[,year_adj]), max(distances_dissimilarities_allyears_onethirdyears_excluded[,year_adj]), by = 0.1)

#predict average lmer
lmer_bray_total_predictions <- data.table(year = lmer_year, year_adj = lmer_year_adj)

#confidence intervals
bray_curtis_total_lmer_confint <- confint(bray_curtis_total_lmer)

#populate data table of lmer predictions
lmer_bray_total_predictions[,bray_curtis_lmer_preds := fixef(bray_curtis_total_lmer)[[1]] + fixef(bray_curtis_total_lmer)[[2]] * year_adj][,bray_curtis_lmer_preds_lowerCI := bray_curtis_total_lmer_confint[5] + bray_curtis_total_lmer_confint[6] * year_adj][,bray_curtis_lmer_preds_upperCI := bray_curtis_total_lmer_confint[11] + bray_curtis_total_lmer_confint[12] * year_adj]
```



##Lollipop SE plot by linear trend experienced

```{r lollipop figure 2b main text}

###############
#FOR LINEAR MODEL INSTEAD OF LINEAR MIXED EFFECTS
###############

bray_curtis_total_coefs_onethirdyears_exclude.r[,Directional_Change_sig := ifelse(differentiating > 0, "Differentiation",ifelse(homogenizing > 0 , "Homogenization", "No trend in\ndissimilarity"))]
years_sampled <- unique(distances_dissimilarities_allyears_onethirdyears_excluded[,.(survey_unit, years_sampled)])
bray_curtis_total_coefs_onethirdyears_exclude.r <- bray_curtis_total_coefs_onethirdyears_exclude.r[years_sampled, on = "survey_unit"]

(BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL_onethirdyears_exclude <- ggplot(data = bray_curtis_total_coefs_onethirdyears_exclude.r, aes(x = reorder(Survey_Name_Season, survey_unit_coefficient) , y = survey_unit_coefficient), label = Survey_Name_Season) +
    geom_errorbar(aes(ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(aes(size = years_sampled, color = Directional_Change_sig), stat = 'identity') +
  scale_color_manual(values = c("#73BA4D","#E0962C","#cbbfde"), name = "Dissimilarity trend", guide="none") +
  scale_size_binned(range = c(1,8), name = "Survey period length\n(years)") +
  geom_hline(yintercept = 0) +
  #scale_y_continuous(breaks = seq(-0.005, 0.0075, by = 0.0025), labels = c("-0.005","","0", "", "0.005",  "")) +
  xlab("Survey unit") +
  ylab("β-diversity trend") + #total BC dissimilarity trend
  coord_flip() +
  theme_classic() +
  theme(axis.text.y = element_text(face = "bold"), axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.title.x = element_text(size = 15), legend.position = c(0.3,0.8), legend.direction = "vertical", legend.text = element_text(size = 15), legend.title = element_text(size = 16)))

ggsave(BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL_onethirdyears_exclude, 
       path = here::here("figures"), filename = "BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL_onethirdyears_exclude.jpg", height = 7, width = 7)

#plot for legend
directional_change_legend_plot_colorbytrend <- BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL_onethirdyears_exclude + 
  theme(legend.position = "right", legend.background = element_rect(fill= "transparent"), 
         legend.text = element_text(size = 15), legend.title = element_text(size = 16)) +
  guides(colour = guide_legend(override.aes = list(size=6)), size = "none")
```


##Wavy Line Plot for GAMs

Generate predicted values (this datatable will hold both jaccard and bray curtis dissimilarities)
```{r generate predicted values GAM}

#generate new data to smooth lines (need year and season survey combinations)
year_survey_unit_expand.dt <- data.table(survey_unit = as.character(NULL), year = as.numeric(NULL), year_adj = as.numeric(NULL ))

for (i in 1:length(survey_unit.list)) {
  #generate year vectors
  survey_unit_years <- unique(distances_dissimilarities_allyears_onethirdyears_excluded[survey_unit == survey_unit.list[i],.(survey_unit, year, year_adj)])
  
  years <- seq(min(survey_unit_years[,year]), max(survey_unit_years[,year]), by = 0.1)
  
  year_adjust <- seq(min(survey_unit_years[,year_adj]), max(survey_unit_years[,year_adj]), by = 0.1)
  
  year_survey_unit_expand.dt_addition <- data.table(survey_unit = survey_unit.list[i], year = years, year_adj = year_adjust)
  
  year_survey_unit_expand.dt <- rbind(year_survey_unit_expand.dt, year_survey_unit_expand.dt_addition)
}

#add colors and names to full year and survey unit combination table
year_survey_unit_expand.dt <- year_survey_unit_expand.dt[color_link_trend, on = "survey_unit"]
```


Get model as predictions
Bray Curtis total, balanced, and gradient
```{r}
#for plotting, get model as predictions
bray_curtis_total_gam_predictions <- predict(bray_curtis_total_gam, se.fit = TRUE, newdata = year_survey_unit_expand.dt)


#merge into table
year_survey_unit_expand.dt[,bray_glm_mod_fit := bray_curtis_total_gam_predictions$fit][,bray_glm_mod_fit_SE := bray_curtis_total_gam_predictions$se.fit]


```

##Color GAMs by trend (year vs dissimilarity)
###BC dissimilarity
```{r color wavy lines by trend BC dissimilarity}

#link distances dissimilarities with trend color hex
distances_dissimilarities_allyears_onethirdyears_excluded <- distances_dissimilarities_allyears_onethirdyears_excluded[color_link_trend, on = "survey_unit"]

#change survey_unit to factor
distances_dissimilarities_allyears_onethirdyears_excluded[,survey_unit := factor(survey_unit)]
year_survey_unit_expand.dt[,survey_unit := factor(survey_unit)]

#check that survey_unit in alpha order
sort(unique(distances_dissimilarities_allyears_onethirdyears_excluded$survey_unit)) == levels(distances_dissimilarities_allyears_onethirdyears_excluded$survey_unit)
sort(unique(year_survey_unit_expand.dt$survey_unit)) == levels(year_survey_unit_expand.dt$survey_unit)

#get list of colors in the right order
trend_colors.dt <- unique(distances_dissimilarities_allyears_onethirdyears_excluded[,.(survey_unit, Survey_Name_Season, trend_color)])

#make sure it matches year_survey_unit_expand.dt
trend_colors.dt == unique(year_survey_unit_expand.dt[,.(survey_unit, Survey_Name_Season, trend_color)])

setorder(trend_colors.dt, survey_unit)


points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude <- ggplot() +
  #full LMER predictions (black)
  geom_ribbon(data = lmer_bray_total_predictions, aes(x = year, ymin = bray_curtis_lmer_preds_lowerCI, ymax = bray_curtis_lmer_preds_upperCI), fill = "grey", alpha = 0.3) +
    geom_line(data = lmer_bray_total_predictions, aes(x = year, y = bray_curtis_lmer_preds), color = "black") +
  #points by trend
  geom_point(data = distances_dissimilarities_allyears_onethirdyears_excluded, cols = "year_adj",
             aes(x = year,
                 y = bray_curtis_dissimilarity_total_mean,
                 fill = survey_unit), alpha = 0.4, size = 1, shape = 21, color = "white") +
  #squiggly lines by survey unit based GAM and colored by trend
    geom_line(data = year_survey_unit_expand.dt, cols = "year_adj",
             aes(x = year,
                 y = bray_glm_mod_fit,
                 color = survey_unit), alpha = 0.6) +
  #confidence intervals for individual GAM
  geom_ribbon(data = year_survey_unit_expand.dt, cols = "year_adj", 
              aes(x = year, ymin=bray_glm_mod_fit-bray_glm_mod_fit_SE, ymax=bray_glm_mod_fit+bray_glm_mod_fit_SE, fill =  survey_unit), alpha=0.1) + #add standard error
  #set color by survey
    scale_color_manual(values = trend_colors.dt$trend_color, name = "Survey Unit") +
  scale_fill_manual(values =trend_colors.dt$trend_color, guide = "none") +
  theme_classic() +
  lims(x = c(min(distances_dissimilarities_allyears_onethirdyears_excluded[,year]),max(distances_dissimilarities_allyears_onethirdyears_excluded[,year])),y = c(0.49,0.95)
       ) +
  xlab("Year") +
ylab("β-diversity") +
  theme(legend.position = "null", axis.text = element_text(size = 15), axis.title = element_text(size = 15))

points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude

ggsave(points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude, path = here::here("figures"), filename ="points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude.jpg", height = 6, width = 11, unit = "in")


points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude_squigglesonly <- ggplot() +
  #points by trend
  geom_point(data = distances_dissimilarities_allyears_onethirdyears_excluded, cols = "year_adj",
             aes(x = year,
                 y = bray_curtis_dissimilarity_total_mean,
                 fill = survey_unit), alpha = 0.4, size = 1, shape = 21, color = "white") +
  #squiggly lines by survey unit based GAM and colored by trend
    geom_line(data = year_survey_unit_expand.dt, cols = "year_adj",
             aes(x = year,
                 y = bray_glm_mod_fit,
                 color = survey_unit), alpha = 0.6) +
  #confidence intervals for individual GAM
  geom_ribbon(data = year_survey_unit_expand.dt, cols = "year_adj", 
              aes(x = year, ymin=bray_glm_mod_fit-bray_glm_mod_fit_SE, ymax=bray_glm_mod_fit+bray_glm_mod_fit_SE, fill =  survey_unit), alpha=0.1) + #add standard error
  #set color by survey
    scale_color_manual(values = trend_colors.dt$trend_color, name = "Survey Unit") +
  scale_fill_manual(values =trend_colors.dt$trend_color, guide = "none") +
  theme_classic() +
  lims(x = c(min(distances_dissimilarities_allyears_onethirdyears_excluded[,year]),max(distances_dissimilarities_allyears_onethirdyears_excluded[,year])),y = c(0.49,0.95)
       ) +
  xlab("Year") +
ylab("β-diversity") +
  theme(legend.position = "null", axis.text = element_text(size = 15), axis.title = element_text(size = 15))

points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude_squigglesonly

ggsave(points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude_squigglesonly, path = here::here("figures"), filename ="points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude_squigglesonly.jpg", height = 6, width = 11, unit = "in")
```


###Merge BC versus Year plot with GAMS and Region vs. coefficient plot for LMs

```{r merge lollipop and wiggly lines}
######################################################
##################BCTOTAL
BC_total_GAM_LM_merge_legend_colorbytrend_onethirdyears_exclude <- ggdraw(xlim = c(0, 40.5), ylim = c(0, 21)) +
    draw_plot(points_wavylines_bray_total_year_reduced_gam_colorbytrend_onethirdyears_exclude + theme(axis.text = element_text(size = 15)),
                                         x = 1, y = 1, width = 20, height = 20) +
    draw_plot(BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL_onethirdyears_exclude +
        theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
              axis.text = element_text(size = 8)), #change legend text font size),
                                         x = 20, y = 1, width = 19, height = 20) +
    draw_plot(get_legend(directional_change_legend_plot_colorbytrend + 
      theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=16), #change legend title font size
        legend.text = element_text(size=15))), #change legend text font size)
                                x = 27, y = 8, width = 3, height = 2) +
  geom_text(aes(x = 2, y = 20.7), label = ("a."), size =8, fontface = "bold") +
  geom_text(aes(x =20, y = 20.7), label = ("b."), size =8, fontface = "bold")

ggsave(BC_total_GAM_LM_merge_legend_colorbytrend_onethirdyears_exclude, path = here::here("figures"), filename = "BC_total_GAM_LM_merge_legend_colorbytrend_onethirdyears_exclude.png", height = 8, width = 14, units = "in")



```

