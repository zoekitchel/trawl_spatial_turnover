---
title: "Dissimilarity time series analysis"
author: ZoÃ« J. Kitchel
date: October 17, 2023
output: html_notebook
---
Primary script 4a for Kitchel et al. 2023 in prep taxonomic diversity manuscript.

```{r setup}
library(data.table)
library(vegan)
library(sf)
library(concaveman) #polygon around points
library(betapart) #allows us to partition beta diversity
library(geosphere)
library(ggpubr) #stat_regline_equation
library(nlme)
library(mgcv) #to make gam
library(cowplot)
library(lme4)
library(stringr)
library(MuMIn)
```

Pull dissimilarity table
```{r pull outputs from previous scripts}
#Pull Dissimilarity Means
distances_dissimilarities_allyears <- readRDS(here::here("output", "dissimilarities", "distances_dissimilarities_allyears.rds"))

#make survey and survey unit factors
distances_dissimilarities_allyears[,survey:=factor(survey)][,survey_unit:=factor(survey_unit)]

#adjust years
distances_dissimilarities_allyears[,year_adj := year-min(year)+1]

#add new variable for year in sequence per region
distances_dissimilarities_allyears[,first_year := min(year),.(survey_unit)]
distances_dissimilarities_allyears[,last_year := max(year),.(survey_unit)]

#distances_dissimilarities_allyears[,year_in_seq := year-first_year+1]

distances_dissimilarities_allyears[,years_sampled := last_year-first_year+1]


```

List of surveys
```{r}
#list of surveys
survey_unit.list <- levels(factor(distances_dissimilarities_allyears$survey_unit))
```

 
 Pull in palette and name helper
```{r}
source(here::here("analysis_code","color_links.R"))
```


##Make GAM (Generalized Additive Models)

Bray Curtis
```{r bray curtis gams}
bray_curtis_total_gam <- gam(bray_curtis_dissimilarity_total_mean ~ year + s(survey_unit, year, bs = "fs", m = 1),#random smooth
                            data = distances_dissimilarities_allyears)

bray_curtis_balanced_gam <- gam(bray_curtis_dissimilarity_balanced_mean ~ year + s(survey_unit, year, bs = "fs", m = 1),#random smooth
                            data = distances_dissimilarities_allyears)

bray_curtis_gradient_gam <- gam(bray_curtis_dissimilarity_gradient_mean ~ year + s(survey_unit, year, bs = "fs", m = 1),#random smooth
                            data = distances_dissimilarities_allyears)

```

Jaccard
```{r jaccard gams}
jaccard_total_gam <- gam(jaccard_dissimilarity_total_mean ~ year + s(survey_unit, year, bs = "fs", m = 1),#random smooth
                            data = distances_dissimilarities_allyears)

```


##Make LMERS

Bray
*These all converged*
```{r bray}
#running with lme instead of lmer gave same results, but allowed for calculation of p-value
bray_curtis_total_lme <- lme(bray_curtis_dissimilarity_total_mean ~ year_adj, random = (~1 + year_adj|survey_unit),data = distances_dissimilarities_allyears)

#but also run with lmer for confint
#total
bray_curtis_total_lmer <- lmer(bray_curtis_dissimilarity_total_mean ~ year_adj + (1 + year_adj|survey_unit),data = distances_dissimilarities_allyears)

#balanced (for comparison plot)
bray_curtis_balanced_lmer <- lmer(bray_curtis_dissimilarity_balanced_mean ~ year_adj + (1 + year_adj|survey_unit),data = distances_dissimilarities_allyears)

#gradient (for comparison plot)
bray_curtis_gradient_lmer <- lmer(bray_curtis_dissimilarity_gradient_mean ~ year_adj + (1 + year_adj|survey_unit),data = distances_dissimilarities_allyears)

#Jaccard total (for comparison plot)
jaccard_total_lmer <- lmer(jaccard_dissimilarity_total_mean ~ year_adj + (1 + year_adj|survey_unit),data = distances_dissimilarities_allyears)


summary(bray_curtis_total_lme)
anova(bray_curtis_total_lme)

bray_curtis_total_coefs <- data.table(coef(bray_curtis_total_lme))
bray_curtis_total_coefs[,survey_unit := rownames(coef(bray_curtis_total_lme))][,Year := round(year_adj,5)][,Intercept := round(`(Intercept)`,2)]
#View(bray_curtis_total_coefs)

bray_curtis_total_coefs <- bray_curtis_total_coefs[color_link, on = "survey_unit"]

bray_curtis_total_coefs.exp <- bray_curtis_total_coefs[,.(Survey_Name_Season, Intercept, Year)]

#export this table
fwrite(bray_curtis_total_coefs.exp, file = here::here("output","bray_curtis_total_coefs.exp.csv"))
```
##Linear Model

Also, build a simple linear model with an interaction (instead of random slope and intercept for survey)
THIS IS HOW WE CLASSIFY SURVEYS as of fall 2023 (update from before, where we classified surveys from LMER)
```{r linear model Bray}

bray_curtis_total_lm <- lm(bray_curtis_dissimilarity_total_mean ~ year * survey_unit,data = distances_dissimilarities_allyears)

bray_curtis_total_coefs <- data.table(summary(bray_curtis_total_lm)$coefficients)
  bray_curtis_total_coefs[,var := rownames(summary(bray_curtis_total_lm)$coefficients)]
  
  #limit to interactions only (check this if there are any model changes!) row 2 and rows 44:84
  bray_curtis_total_coefs.r <- bray_curtis_total_coefs[c(2,44:84),]
  
  #adjust survey unit name by deleting beginning of string
  bray_curtis_total_coefs.r[,survey_unit := substr(var, 17, str_length(var))][var == "year",survey_unit := "AI"]
  
  #calculate interaction coefficients
  AI_estimate <- bray_curtis_total_coefs.r[1,Estimate]
  bray_curtis_total_coefs.r[1,survey_unit_coefficient := AI_estimate]
  bray_curtis_total_coefs.r[2:42,survey_unit_coefficient := (AI_estimate + Estimate)]
  
  #homogenizing vs differentiating
  bray_curtis_total_coefs.r[,differentiating := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient > 0),1,0)][,homogenizing := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient < 0),1,0)]
  
  #lower and upper CI
    bray_curtis_total_coefs.r[,lwr := survey_unit_coefficient-`Std. Error`][,upr:= survey_unit_coefficient+`Std. Error`]
    
    #save as output
    fwrite(bray_curtis_total_coefs.r, here::here("output","bray_curtis_total_coefs.r.csv"))
  
  bray_curtis_total_coefs_sum <- data.table(differentiating = sum(  bray_curtis_total_coefs.r$differentiating), homogenizing = sum(  bray_curtis_total_coefs.r$homogenizing))
  
  #hex by trend
  bray_curtis_total_coefs.r[,trend_color := ifelse(homogenizing == 1, "#e7ac5b", ifelse(differentiating == 1,"#91c874","#D81C60"))]
  
  #link to color link
  bray_curtis_total_coefs.r <- color_link[bray_curtis_total_coefs.r, on = "survey_unit"]
  
  color_link_trend <- bray_curtis_total_coefs.r[,.(survey_unit,Survey_Name_Season, hex,  trend_color)]

```

Same, but for Jaccard
```{r linear model Jaccard}

jaccard_total_lm <- lm(jaccard_dissimilarity_total_mean ~ year * survey_unit,data = distances_dissimilarities_allyears)

jaccard_total_coefs <- data.table(summary(jaccard_total_lm)$coefficients)
  jaccard_total_coefs[,var := rownames(summary(jaccard_total_lm)$coefficients)]
  
  #limit to interactions only (check this if there are any model changes!) row 2 and rows 44:84
  jaccard_total_coefs.r <- jaccard_total_coefs[c(2,44:84),]
  
  #adjust survey unit name by deleting beginning of string
  jaccard_total_coefs.r[,survey_unit := substr(var, 17, str_length(var))][var == "year",survey_unit := "AI"]
  
  #calculate interaction coefficients
  AI_estimate <- jaccard_total_coefs.r[1,Estimate]
  jaccard_total_coefs.r[1,survey_unit_coefficient := AI_estimate]
  jaccard_total_coefs.r[2:42,survey_unit_coefficient := (AI_estimate + Estimate)]
  
  #homogenizing vs differentiating
  jaccard_total_coefs.r[,differentiating := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient > 0),1,0)][,homogenizing := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient < 0),1,0)]
  
  #lower and upper CI
    jaccard_total_coefs.r[,lwr := survey_unit_coefficient-`Std. Error`][,upr:= survey_unit_coefficient+`Std. Error`]
  
  jaccard_total_coefs_sum <- data.table(differentiating = sum(  jaccard_total_coefs.r$differentiating), homogenizing = sum(  jaccard_total_coefs.r$homogenizing))
  
  #hex by trend
  jaccard_total_coefs.r[,trend_color_jaccard := ifelse(homogenizing == 1, "#e7ac5b", ifelse(differentiating == 1,"#91c874","#D81C60"))]
  
  #link to color link
  jaccard_total_coefs.r <- color_link[jaccard_total_coefs.r, on = "survey_unit"]
  
  color_link_jaccard <- unique(jaccard_total_coefs.r[,.(survey_unit,trend_color_jaccard)])
  
  color_link_trend <- color_link_jaccard[color_link_trend, on = "survey_unit"]

```

Same, but for Bray Curtis balanced changes
```{r linear model BC balanced changes}

bray_curtis_balanced_lm <- lm(bray_curtis_dissimilarity_balanced_mean ~ year * survey_unit,data = distances_dissimilarities_allyears)

bray_curtis_balanced_coefs <- data.table(summary(bray_curtis_balanced_lm)$coefficients)
  bray_curtis_balanced_coefs[,var := rownames(summary(bray_curtis_balanced_lm)$coefficients)]
  
  #limit to interactions only (check this if there are any model changes!) row 2 and rows 44:84
  bray_curtis_balanced_coefs.r <- bray_curtis_balanced_coefs[c(2,44:84),]
  
  #adjust survey unit name by deleting beginning of string
  bray_curtis_balanced_coefs.r[,survey_unit := substr(var, 17, str_length(var))][var == "year",survey_unit := "AI"]
  
  #calculate interaction coefficients
  AI_estimate <- bray_curtis_balanced_coefs.r[1,Estimate]
  bray_curtis_balanced_coefs.r[1,survey_unit_coefficient := AI_estimate]
  bray_curtis_balanced_coefs.r[2:42,survey_unit_coefficient := (AI_estimate + Estimate)]
  
  #homogenizing vs differentiating
  bray_curtis_balanced_coefs.r[,differentiating := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient > 0),1,0)][,homogenizing := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient < 0),1,0)]
  
  #lower and upper CI
    bray_curtis_balanced_coefs.r[,lwr := survey_unit_coefficient-`Std. Error`][,upr:= survey_unit_coefficient+`Std. Error`]
  
  bray_curtis_balanced_coefs_sum <- data.table(differentiating = sum(  bray_curtis_balanced_coefs.r$differentiating), homogenizing = sum(  bray_curtis_balanced_coefs.r$homogenizing))
  
  #hex by trend
  bray_curtis_balanced_coefs.r[,trend_color_bray_curtis_balanced := ifelse(homogenizing == 1, "#e7ac5b", ifelse(differentiating == 1,"#91c874","#D81C60"))]
  
  #link to color link
  bray_curtis_balanced_coefs.r <- color_link[bray_curtis_balanced_coefs.r, on = "survey_unit"]
  
  color_link_bray_curtis_balanced <- unique(bray_curtis_balanced_coefs.r[,.(survey_unit,trend_color_bray_curtis_balanced)])
  
  color_link_trend <- color_link_bray_curtis_balanced[color_link_trend, on = "survey_unit"]

```

Same, but for Bray Curtis abundance gradients
```{r linear model BC abundance gradients}

bray_curtis_gradient_lm <- lm(bray_curtis_dissimilarity_gradient_mean ~ year * survey_unit,data = distances_dissimilarities_allyears)

bray_curtis_gradient_coefs <- data.table(summary(bray_curtis_gradient_lm)$coefficients)
  bray_curtis_gradient_coefs[,var := rownames(summary(bray_curtis_gradient_lm)$coefficients)]
  
  #limit to interactions only (check this if there are any model changes!) row 2 and rows 44:84
  bray_curtis_gradient_coefs.r <- bray_curtis_gradient_coefs[c(2,44:84),]
  
  #adjust survey unit name by deleting beginning of string
  bray_curtis_gradient_coefs.r[,survey_unit := substr(var, 17, str_length(var))][var == "year",survey_unit := "AI"]
  
  #calculate interaction coefficients
  AI_estimate <- bray_curtis_gradient_coefs.r[1,Estimate]
  bray_curtis_gradient_coefs.r[1,survey_unit_coefficient := AI_estimate]
  bray_curtis_gradient_coefs.r[2:42,survey_unit_coefficient := (AI_estimate + Estimate)]
  
  #homogenizing vs differentiating
  bray_curtis_gradient_coefs.r[,differentiating := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient > 0),1,0)][,homogenizing := ifelse((`Std. Error`< abs(survey_unit_coefficient) & survey_unit_coefficient < 0),1,0)]
  
  #lower and upper CI
    bray_curtis_gradient_coefs.r[,lwr := survey_unit_coefficient-`Std. Error`][,upr:= survey_unit_coefficient+`Std. Error`]
  
  bray_curtis_gradient_coefs_sum <- data.table(differentiating = sum(  bray_curtis_gradient_coefs.r$differentiating), homogenizing = sum(  bray_curtis_gradient_coefs.r$homogenizing))
  
  #hex by trend
  bray_curtis_gradient_coefs.r[,trend_color_bray_curtis_gradient := ifelse(homogenizing == 1, "#e7ac5b", ifelse(differentiating == 1,"#91c874","#D81C60"))]
  
  #link to color link
  bray_curtis_gradient_coefs.r <- color_link[bray_curtis_gradient_coefs.r, on = "survey_unit"]
  
  color_link_bray_curtis_gradient <- unique(bray_curtis_gradient_coefs.r[,.(survey_unit,trend_color_bray_curtis_gradient)])
  
  color_link_trend <- color_link_bray_curtis_gradient[color_link_trend, on = "survey_unit"]

```

Get LMER model as predictions
```{r TOTAL BC}

# need to sort out year in seq versus overall year models
#new data for lmer
lmer_year <- seq(min(distances_dissimilarities_allyears[,year]), max(distances_dissimilarities_allyears[,year]), by = 0.1)

lmer_year_adj <- seq(min(distances_dissimilarities_allyears[,year_adj]), max(distances_dissimilarities_allyears[,year_adj]), by = 0.1)

#predict average lmer
lmer_bray_total_predictions <- data.table(year = lmer_year, year_adj = lmer_year_adj)

#confidence intervals
bray_curtis_total_lmer_confint <- confint(bray_curtis_total_lmer)

#populate data table of lmer predictions
lmer_bray_total_predictions[,bray_curtis_lmer_preds := fixef(bray_curtis_total_lmer)[[1]] + fixef(bray_curtis_total_lmer)[[2]] * year_adj][,bray_curtis_lmer_preds_lowerCI := bray_curtis_total_lmer_confint[5] + bray_curtis_total_lmer_confint[6] * year_adj][,bray_curtis_lmer_preds_upperCI := bray_curtis_total_lmer_confint[11] + bray_curtis_total_lmer_confint[12] * year_adj]
```
Balanced changes component of BC dissimilarity
```{r BALANCED BC}

# need to sort out year in seq versus overall year models
#new data for lmer


#predict average lmer
lmer_bray_balanced_predictions <- data.table(year = lmer_year, year_adj = lmer_year_adj)

#confidence intervals
bray_curtis_balanced_lmer_confint <- confint(bray_curtis_balanced_lmer)

#populate data table of lmer predictions
lmer_bray_balanced_predictions[,bray_curtis_lmer_preds := fixef(bray_curtis_balanced_lmer)[[1]] + fixef(bray_curtis_balanced_lmer)[[2]] * year_adj][,bray_curtis_lmer_preds_lowerCI := bray_curtis_balanced_lmer_confint[5] + bray_curtis_balanced_lmer_confint[6] * year_adj][,bray_curtis_lmer_preds_upperCI := bray_curtis_balanced_lmer_confint[11] + bray_curtis_balanced_lmer_confint[12] * year_adj]
```
Abundance gradients component of BC dissimilarity
```{r GRADIENT BC}

# need to sort out year in seq versus overall year models


#predict average lmer
lmer_bray_gradient_predictions <- data.table(year = lmer_year, year_adj = lmer_year_adj)

#confidence intervals
bray_curtis_gradient_lmer_confint <- confint(bray_curtis_gradient_lmer)

#populate data table of lmer predictions
lmer_bray_gradient_predictions[,bray_curtis_lmer_preds := fixef(bray_curtis_gradient_lmer)[[1]] + fixef(bray_curtis_gradient_lmer)[[2]] * year_adj][,bray_curtis_lmer_preds_lowerCI := bray_curtis_gradient_lmer_confint[5] + bray_curtis_gradient_lmer_confint[6] * year_adj][,bray_curtis_lmer_preds_upperCI := bray_curtis_gradient_lmer_confint[11] + bray_curtis_gradient_lmer_confint[12] * year_adj]
```

```{r total jaccard}

# need to sort out year in seq versus overall year models


#predict average lmer
lmer_jaccard_total_predictions <- data.table(year = lmer_year, year_adj = lmer_year_adj)

#confidence intervals
jaccard_total_lmer_confint <- confint(jaccard_total_lmer)

#populate data table of lmer predictions
lmer_jaccard_total_predictions[,jaccard_lmer_preds := fixef(jaccard_total_lmer)[[1]] + fixef(jaccard_total_lmer)[[2]] * year_adj][,jaccard_lmer_preds_lowerCI := jaccard_total_lmer_confint[5] + jaccard_total_lmer_confint[6] * year_adj][,jaccard_lmer_preds_upperCI := jaccard_total_lmer_confint[11] + jaccard_total_lmer_confint[12] * year_adj]
```


Total versus balanced BC plot
```{r}
ggplot(distances_dissimilarities_allyears) +
  geom_point(aes(bray_curtis_dissimilarity_total_mean, bray_curtis_dissimilarity_balanced_mean)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(aes(bray_curtis_dissimilarity_total_mean, bray_curtis_dissimilarity_balanced_mean)) +
  theme_classic() +
  labs(x = "Total BC dissimilarity",  y = "Balanced changes in abundance/biomass")

ggplot(distances_dissimilarities_allyears) +
  geom_point(aes(bray_curtis_dissimilarity_total_mean, bray_curtis_dissimilarity_gradient_mean)) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(aes(bray_curtis_dissimilarity_total_mean, bray_curtis_dissimilarity_gradient_mean)) +
  theme_classic() +
  labs(x = "Total BC dissimilarity",  y = "Abundance/biomass gradient")

#all on one plot
#reduced
distances_dissimilarities_allyears.r <- distances_dissimilarities_allyears[,.(year, bray_curtis_dissimilarity_total_mean, bray_curtis_dissimilarity_gradient_mean, bray_curtis_dissimilarity_balanced_mean, jaccard_dissimilarity_total_mean)]

#wide to long
dissim_long <- melt(distances_dissimilarities_allyears.r, id.vars = c("year"), variable.name = "Î²-diversity metric")

dissim_long[,`Î²-diversity metric` := factor(`Î²-diversity metric`, levels = c( "bray_curtis_dissimilarity_total_mean","bray_curtis_dissimilarity_balanced_mean","bray_curtis_dissimilarity_gradient_mean", "jaccard_dissimilarity_total_mean"))]

BC_dissimilarity_components <- ggplot() +
  geom_point(data = dissim_long[`Î²-diversity metric` != "jaccard_dissimilarity_total_mean",], aes(x = year, y = value, color = `Î²-diversity metric`), alpha = 0.2, size = 1) +
  geom_ribbon(data = lmer_bray_total_predictions, aes(x = year, ymin = bray_curtis_lmer_preds_lowerCI, ymax = bray_curtis_lmer_preds_upperCI), fill = "black", alpha = 0.3) +
  geom_line(data = lmer_bray_total_predictions, aes(x = year, y = bray_curtis_lmer_preds), color = "black") +
  #balanced
    geom_ribbon(data = lmer_bray_gradient_predictions, aes(x = year, ymin = bray_curtis_lmer_preds_lowerCI, ymax = bray_curtis_lmer_preds_upperCI), fill = "cadetblue3", alpha = 0.3) +
  geom_line(data = lmer_bray_gradient_predictions, aes(x = year, y = bray_curtis_lmer_preds), color = "cadetblue3") +
  #gradient
    geom_ribbon(data = lmer_bray_balanced_predictions, aes(x = year, ymin = bray_curtis_lmer_preds_lowerCI, ymax = bray_curtis_lmer_preds_upperCI), fill = "darksalmon", alpha = 0.3) +
  geom_line(data = lmer_bray_balanced_predictions, aes(x = year, y = bray_curtis_lmer_preds), color = "darksalmon") +
  #fix. colors of points
  scale_color_manual(values = c("black","darksalmon","cadetblue3"), labels = c("Total","Balanced variation\nin abundance","Biomass gradient")) +
  labs(x = "Year", y = "Value") +
  lims(y = c(min(dissim_long$value), max(dissim_long$value))) +
  theme_classic() +
  theme(legend.position = c(0.17,0.37))

ggsave(BC_dissimilarity_components, path = here::here("figures"), filename=("BC_dissimilarity_components.jpg"), width = 6.5, height = 5, units = "in")

#Jaccard
Jaccard_dissimilarity <- ggplot() +
  geom_point(data = dissim_long[`Î²-diversity metric` == "jaccard_dissimilarity_total_mean"], aes(x = year, y = value), alpha = 0.2, size = 1) +
  geom_ribbon(data = lmer_jaccard_total_predictions, aes(x = year, ymin = jaccard_lmer_preds_lowerCI, ymax = jaccard_lmer_preds_upperCI), fill = "black", alpha = 0.3) +
  geom_line(data = lmer_jaccard_total_predictions, aes(x = year, y = jaccard_lmer_preds), color = "black") +
  labs(x = "Year", y = "Total Jaccard dissimilarity") +
  lims(y = c(min(dissim_long$value), max(dissim_long$value))) +
  theme_classic()

ggsave(Jaccard_dissimilarity, path = here::here("figures"), filename=("Jaccard_dissimilarity.jpg"), width = 6.5, height = 5, units = "in")

#merge
library(cowplot)
all_dissimilarities_over_time <- plot_grid(BC_dissimilarity_components + theme(legend.background = element_rect(fill = "transparent")),
                                           Jaccard_dissimilarity,
                                           ncol = 2, align = "hv", labels = c("a.","b."))

ggsave(all_dissimilarities_over_time, filename = "all_dissimilarities_over_time.jpg", path = here::here("figures"), width = 10, height = 4.5, units = "in")

  
```


##Lollipop SE plot by linear trend experienced

```{r lollipop figure 2b main text}

###############
#FOR LINEAR MODEL INSTEAD OF LINEAR MIXED EFFECTS
###############

bray_curtis_total_coefs.r[,Directional_Change_sig := ifelse(differentiating > 0, "Differentiation",ifelse(homogenizing > 0 , "Homogenization", "No trend in\ndissimilarity"))]
years_sampled <- unique(distances_dissimilarities_allyears[,.(survey_unit, years_sampled)])
bray_curtis_total_coefs.r <- bray_curtis_total_coefs.r[years_sampled, on = "survey_unit"]

(BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL <- ggplot(data = bray_curtis_total_coefs.r, aes(x = reorder(Survey_Name_Season, survey_unit_coefficient) , y = survey_unit_coefficient), label = Survey_Name_Season) +
    geom_errorbar(aes(ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(aes(size = years_sampled, color = Directional_Change_sig), stat = 'identity') +
  scale_color_manual(values = c("#FFC109","#1E88E5","#D81C60"), name = "Dissimilarity trend", guide="none") +
  scale_size_binned(range = c(1,8), name = "Survey period length\n(years)") +
  geom_hline(yintercept = 0) +
  #scale_y_continuous(breaks = seq(-0.005, 0.0075, by = 0.0025), labels = c("-0.005","","0", "", "0.005",  "")) +
  xlab("Survey unit") +
  ylab("Î²-diversity trend") + #total BC dissimilarity trend
  coord_flip() +
  theme_classic() +
  theme(axis.text.y = element_text(face = "bold"), axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.title.x = element_text(size = 15), legend.position = c(0.3,0.8), legend.direction = "vertical", legend.text = element_text(size = 15), legend.title = element_text(size = 16)))

ggsave(BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL, 
       path = here::here("figures"), filename = "BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL.jpg", height = 7, width = 7)

#plot for legend
directional_change_legend_plot_colorbytrend <- BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL + 
  theme(legend.position = "right", legend.background = element_rect(fill= "transparent"), 
         legend.text = element_text(size = 15), legend.title = element_text(size = 16)) +
  guides(colour = guide_legend(override.aes = list(size=6)), size = "none")
```

Jaccard total dissimilarity
```{r lollipop figure jaccard total dissimilarity}


jaccard_total_coefs.r[,Directional_Change_sig := ifelse(differentiating > 0, "Differentiation",ifelse(homogenizing > 0 , "Homogenization", "No trend in\ndissimilarity"))]
years_sampled <- unique(distances_dissimilarities_allyears[,.(survey_unit, years_sampled)])
jaccard_total_coefs.r <- jaccard_total_coefs.r[years_sampled, on = "survey_unit"]

(jaccard_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL <- ggplot(data = jaccard_total_coefs.r, aes(x = reorder(Survey_Name_Season, survey_unit_coefficient) , y = survey_unit_coefficient), label = Survey_Name_Season) +
    geom_errorbar(aes(ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(aes(size = years_sampled, color = Directional_Change_sig), stat = 'identity') +
  scale_color_manual(values = c("#FFC109","#1E88E5","#D81C60"), name = "Î²-diversity trend\nTotal Jaccard dissimilarity", guide="none") +
  scale_size_binned(range = c(1,8), name = "Survey period length\n(years)") +
  geom_hline(yintercept = 0) +
  #scale_y_continuous(breaks = seq(-0.005, 0.0075, by = 0.0025), labels = c("-0.005","","0", "", "0.005",  "")) +
  xlab("Survey unit") +
  ylab("Î²-diversity trend\nTotal Jaccard dissimilarity") + #total jaccard dissimilarity trend
  coord_flip() +
  theme_classic() +
  theme(axis.text.y = element_text(face = "bold"), axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.title.x = element_text(size = 15), legend.position = c(0.3,0.8), legend.direction = "vertical", legend.text = element_text(size = 15), legend.title = element_text(size = 16)))

ggsave(jaccard_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL, 
       path = here::here("figures"), filename = "jaccard_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL.jpg", height = 7, width = 7)

```
Balanced changes component of Bray Curtis dissimilarity
```{r lollipop figure balanced changes bray curtis}

bray_curtis_balanced_coefs.r[,Directional_Change_sig := ifelse(differentiating > 0, "Differentiation",ifelse(homogenizing > 0 , "Homogenization", "No trend in\ndissimilarity"))]
years_sampled <- unique(distances_dissimilarities_allyears[,.(survey_unit, years_sampled)])
bray_curtis_balanced_coefs.r <- bray_curtis_balanced_coefs.r[years_sampled, on = "survey_unit"]

(BC_balanced_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL <- ggplot(data = bray_curtis_balanced_coefs.r, aes(x = reorder(Survey_Name_Season, survey_unit_coefficient) , y = survey_unit_coefficient), label = Survey_Name_Season) +
    geom_errorbar(aes(ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(aes(size = years_sampled, color = Directional_Change_sig), stat = 'identity') +
  scale_color_manual(values = c("#FFC109","#1E88E5","#D81C60"), name = "Î²-diversity trend\nBray Curtis balanced changes in abundance", guide="none") +
  scale_size_binned(range = c(1,8), name = "Survey period length\n(years)") +
  geom_hline(yintercept = 0) +
  #scale_y_continuous(breaks = seq(-0.005, 0.0075, by = 0.0025), labels = c("-0.005","","0", "", "0.005",  "")) +
  xlab("Survey unit") +
  ylab("Î²-diversity trend\nBray Curtis balanced changes in abundance") + #balanced BC dissimilarity trend
  coord_flip() +
  theme_classic() +
  theme(axis.text.y = element_text(face = "bold"), axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.title.x = element_text(size = 15), legend.position = c(0.3,0.8), legend.direction = "vertical", legend.text = element_text(size = 15), legend.title = element_text(size = 16)))

ggsave(BC_balanced_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL, 
       path = here::here("figures"), filename = "BC_balanced_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL.jpg", height = 7, width = 7)

```
 
 Bray Curtis Abundance Gradients component of dissimilarity
```{r lollipop figure BC abundance gradients}

bray_curtis_gradient_coefs.r[,Directional_Change_sig := ifelse(differentiating > 0, "Differentiation",ifelse(homogenizing > 0 , "Homogenization", "No trend in\ndissimilarity"))]
years_sampled <- unique(distances_dissimilarities_allyears[,.(survey_unit, years_sampled)])
bray_curtis_gradient_coefs.r <- bray_curtis_gradient_coefs.r[years_sampled, on = "survey_unit"]

(BC_gradient_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL <- ggplot(data = bray_curtis_gradient_coefs.r, aes(x = reorder(Survey_Name_Season, survey_unit_coefficient) , y = survey_unit_coefficient), label = Survey_Name_Season) +
    geom_errorbar(aes(ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(aes(size = years_sampled, color = Directional_Change_sig), stat = 'identity') +
  scale_color_manual(values = c("#FFC109","#1E88E5","#D81C60"), name = "Î²-diversity trend\nBray Curtis abundance gradients", guide="none") +
  scale_size_binned(range = c(1,8), name = "Survey period length\n(years)") +
  geom_hline(yintercept = 0) +
  #scale_y_continuous(breaks = seq(-0.005, 0.0075, by = 0.0025), labels = c("-0.005","","0", "", "0.005",  "")) +
  xlab("Survey unit") +
  ylab("Î²-diversity trend\nBray Curtis abundance gradients") + #gradient BC dissimilarity trend
  coord_flip() +
  theme_classic() +
  theme(axis.text.y = element_text(face = "bold"), axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.title.x = element_text(size = 15), legend.position = c(0.22,0.8), legend.direction = "vertical", legend.text = element_text(size = 15), legend.title = element_text(size = 16),
  legend.background = element_rect(fill='transparent') #transparent legend bg
  ))

ggsave(BC_gradient_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL, 
       path = here::here("figures"), filename = "BC_gradient_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL.jpg", height = 7, width = 7)

```


##Wavy Line Plot for GAMs (Figure 2a)

Generate predicted values (this datatable will hold both jaccard and bray curtis dissimilarities)
```{r generate predicted values GAM}
#generate list again, as for some reason it doesn't stay in environment
survey_unit.list <- levels(factor(distances_dissimilarities_allyears$survey_unit))

#generate new data to smooth lines (need year and season survey combinations)
year_survey_unit_expand.dt <- data.table(survey_unit = as.character(NULL), year = as.numeric(NULL), year_adj = as.numeric(NULL ))

for (i in 1:length(survey_unit.list)) {
  #generate year vectors
  survey_unit_years <- unique(distances_dissimilarities_allyears[survey_unit == survey_unit.list[i],.(survey_unit, year, year_adj)])
  
  years <- seq(min(survey_unit_years[,year]), max(survey_unit_years[,year]), by = 0.1)
  
  year_adjust <- seq(min(survey_unit_years[,year_adj]), max(survey_unit_years[,year_adj]), by = 0.1)
  
  year_survey_unit_expand.dt_addition <- data.table(survey_unit = survey_unit.list[i], year = years, year_adj = year_adjust)
  
  year_survey_unit_expand.dt <- rbind(year_survey_unit_expand.dt, year_survey_unit_expand.dt_addition)
}

#add colors and names to full year and survey unit combination table
year_survey_unit_expand.dt <- year_survey_unit_expand.dt[color_link_trend, on = "survey_unit"]
```


Get model as predictions
Bray Curtis total, balanced, and gradient
```{r}
#for plotting, get model as predictions
bray_curtis_total_gam_predictions <- predict(bray_curtis_total_gam, se.fit = TRUE, newdata = year_survey_unit_expand.dt)

bray_curtis_balanced_gam_predictions <- predict(bray_curtis_balanced_gam, se.fit = TRUE, newdata = year_survey_unit_expand.dt)

bray_curtis_gradient_gam_predictions <- predict(bray_curtis_gradient_gam, se.fit = TRUE, newdata = year_survey_unit_expand.dt)


#merge into table
year_survey_unit_expand.dt[,bray_glm_mod_fit := bray_curtis_total_gam_predictions$fit][,bray_glm_mod_fit_SE := bray_curtis_total_gam_predictions$se.fit]
year_survey_unit_expand.dt[,bray_glm_mod_fit_balanced := bray_curtis_balanced_gam_predictions$fit][,bray_glm_mod_fit_balanced_SE := bray_curtis_balanced_gam_predictions$se.fit]
year_survey_unit_expand.dt[,bray_glm_mod_fit_gradient := bray_curtis_gradient_gam_predictions$fit][,bray_glm_mod_fit_gradient_SE := bray_curtis_gradient_gam_predictions$se.fit]

```

Jaccard
Get model as predictions
```{r}
#for plotting, get model as predictions
jaccard_total_gam_predictions <- predict(jaccard_total_gam, se.fit = TRUE, newdata = year_survey_unit_expand.dt)

#merge into table
year_survey_unit_expand.dt[,jaccard_glm_mod_fit := jaccard_total_gam_predictions$fit][,jaccard_glm_mod_fit_SE := jaccard_total_gam_predictions$se.fit]

```


##Color GAMs by trend (year vs dissimilarity)
###BC dissimilarity
```{r color wavy lines by trend BC dissimilarity}

#link distances dissimilarities with trend color hex
distances_dissimilarities_allyears <- distances_dissimilarities_allyears[color_link_trend, on = "survey_unit"]

#change survey_unit to factor
distances_dissimilarities_allyears[,survey_unit := factor(survey_unit)]
year_survey_unit_expand.dt[,survey_unit := factor(survey_unit)]

#check that survey_unit in alpha order
sort(unique(distances_dissimilarities_allyears$survey_unit)) == levels(distances_dissimilarities_allyears$survey_unit)
sort(unique(year_survey_unit_expand.dt$survey_unit)) == levels(year_survey_unit_expand.dt$survey_unit)

#get list of colors in the right order
trend_colors.dt <- unique(distances_dissimilarities_allyears[,.(survey_unit, Survey_Name_Season, trend_color)])

#make sure it matches year_survey_unit_expand.dt
trend_colors.dt == unique(year_survey_unit_expand.dt[,.(survey_unit, Survey_Name_Season, trend_color)])

setorder(trend_colors.dt, survey_unit)


points_wavylines_bray_total_year_reduced_gam_colorbytrend <- ggplot() +
  #full LMER predictions (black)
  geom_ribbon(data = lmer_bray_total_predictions, aes(x = year, ymin = bray_curtis_lmer_preds_lowerCI, ymax = bray_curtis_lmer_preds_upperCI), fill = "grey", alpha = 0.3) +
    geom_line(data = lmer_bray_total_predictions, aes(x = year, y = bray_curtis_lmer_preds), color = "black") +
  #points by trend
  geom_point(data = distances_dissimilarities_allyears, cols = "year_adj",
             aes(x = year,
                 y = bray_curtis_dissimilarity_total_mean,
                 fill = survey_unit), alpha = 0.4, size = 1, shape = 21, color = "white") +
  #squiggly lines by survey unit based GAM and colored by trend
    geom_line(data = year_survey_unit_expand.dt, cols = "year_adj",
             aes(x = year,
                 y = bray_glm_mod_fit,
                 color = survey_unit), alpha = 0.6) +
  #add year breaks
  scale_x_continuous(breaks = c(1968,1980,1990,2000,2010,2021), limits = c(1968,2024))+
  #confidence intervals for individual GAM
  geom_ribbon(data = year_survey_unit_expand.dt, cols = "year_adj", 
              aes(x = year, ymin=bray_glm_mod_fit-bray_glm_mod_fit_SE, ymax=bray_glm_mod_fit+bray_glm_mod_fit_SE, fill =  survey_unit), alpha=0.1) + #add standard error
  #set color by survey
    scale_color_manual(values = trend_colors.dt$trend_color, name = "Survey Unit") +
  scale_fill_manual(values =trend_colors.dt$trend_color, guide = "none") +
  theme_classic() +
  xlab("Year") +
ylab("Î²-diversity") +
  theme(legend.position = "null", axis.text = element_text(size = 15), axis.title = element_text(size = 15))


points_wavylines_bray_total_year_reduced_gam_colorbytrend

ggsave(points_wavylines_bray_total_year_reduced_gam_colorbytrend, path = here::here("figures"), filename ="points_wavylines_bray_total_year_reduced_gam_colorbytrend.jpg", height = 6, width = 11, unit = "in")


points_wavylines_bray_total_year_reduced_gam_colorbytrend_squigglesonly <- ggplot() +
  #points by trend
  geom_point(data = distances_dissimilarities_allyears, cols = "year_adj",
             aes(x = year,
                 y = bray_curtis_dissimilarity_total_mean,
                 fill = survey_unit), alpha = 0.4, size = 1, shape = 21, color = "white") +
  #squiggly lines by survey unit based GAM and colored by trend
    geom_line(data = year_survey_unit_expand.dt, cols = "year_adj",
             aes(x = year,
                 y = bray_glm_mod_fit,
                 color = survey_unit), alpha = 0.6) +
  #add year breaks
  scale_x_continuous(breaks = c(1968,1980,1990,2000,2010,2021), limits = c(1968,2024))+
  #confidence intervals for individual GAM
  geom_ribbon(data = year_survey_unit_expand.dt, cols = "year_adj", 
              aes(x = year, ymin=bray_glm_mod_fit-bray_glm_mod_fit_SE, ymax=bray_glm_mod_fit+bray_glm_mod_fit_SE, fill =  survey_unit), alpha=0.1) + #add standard error
  #set color by survey
    scale_color_manual(values = trend_colors.dt$trend_color, name = "Survey Unit") +
  scale_fill_manual(values =trend_colors.dt$trend_color, guide = "none") +
  theme_classic() +
  xlab("Year") +
ylab("Î²-diversity") +
  theme(legend.position = "null", axis.text = element_text(size = 15), axis.title = element_text(size = 15))

points_wavylines_bray_total_year_reduced_gam_colorbytrend_squigglesonly

ggsave(points_wavylines_bray_total_year_reduced_gam_colorbytrend_squigglesonly, path = here::here("figures"), filename ="points_wavylines_bray_total_year_reduced_gam_colorbytrend_squigglesonly.jpg", height = 6, width = 11, unit = "in")
```

##Color GAMs by trend (year vs dissimilarity)
###Jaccard dissimilarity
```{r color wavy lines by trend Jaccard dissimilarity}

points_wavylines_jaccard_total_year_reduced_gam_colorbytrend <- ggplot() +
  #full LMER predictions (black)
  geom_ribbon(data = lmer_jaccard_total_predictions, aes(x = year, ymin = jaccard_lmer_preds_lowerCI, ymax = jaccard_lmer_preds_upperCI), fill = "grey", alpha = 0.3) +
    geom_line(data = lmer_jaccard_total_predictions, aes(x = year, y = jaccard_lmer_preds), color = "black") +
  #points by trend
  geom_point(data = distances_dissimilarities_allyears, cols = "year_adj",
             aes(x = year,
                 y = jaccard_dissimilarity_total_mean,
                 fill = survey_unit), alpha = 0.4, size = 1, shape = 21, color = "white") +
  #squiggly lines by survey unit based GAM and colored by trend
    geom_line(data = year_survey_unit_expand.dt, cols = "year_adj",
             aes(x = year,
                 y = jaccard_glm_mod_fit,
                 color = survey_unit), alpha = 0.6) +
  #confidence intervals for individual GAM
  geom_ribbon(data = year_survey_unit_expand.dt, cols = "year_adj", 
              aes(x = year, ymin=jaccard_glm_mod_fit-jaccard_glm_mod_fit_SE, ymax=jaccard_glm_mod_fit+jaccard_glm_mod_fit_SE, fill =  survey_unit), alpha=0.1) + #add standard error
  #set color by survey
    scale_color_manual(values = trend_colors.dt$trend_color, name = "Survey Unit") +
  scale_fill_manual(values =trend_colors.dt$trend_color, guide = "none") +
  theme_classic() +
  lims(x = c(min(distances_dissimilarities_allyears[,year]),max(distances_dissimilarities_allyears[,year]))
       ) +
  xlab("Year\n") +
ylab("Î²-diversity\n(Jaccard dissimilarity)") +
  theme(legend.position = "null", axis.text = element_text(size = 15), axis.title = element_text(size = 15))

points_wavylines_jaccard_total_year_reduced_gam_colorbytrend

ggsave(points_wavylines_jaccard_total_year_reduced_gam_colorbytrend, path = here::here("figures"), filename ="points_wavylines_jaccard_total_year_reduced_gam_colorbytrend.jpg", height = 6, width = 11, unit = "in")

```

Bray Curtis balanced changes
```{r color wavy lines by trend Bray Curtis balanced}

points_wavylines_bray_curtis_balanced_year_reduced_gam_colorbytrend <- ggplot() +
  #full LMER predictions (black)
  geom_ribbon(data = lmer_bray_balanced_predictions, aes(x = year, ymin = bray_curtis_lmer_preds_lowerCI, ymax = bray_curtis_lmer_preds_upperCI), fill = "grey", alpha = 0.3) +
    geom_line(data = lmer_bray_balanced_predictions, aes(x = year, y = bray_curtis_lmer_preds), color = "black") +
  #points by trend
  geom_point(data = distances_dissimilarities_allyears, cols = "year_adj",
             aes(x = year,
                 y = bray_curtis_dissimilarity_balanced_mean,
                 fill = survey_unit), alpha = 0.4, size = 1, shape = 21, color = "white") +
  #squiggly lines by survey unit based GAM and colored by trend
    geom_line(data = year_survey_unit_expand.dt, cols = "year_adj",
             aes(x = year,
                 y = bray_glm_mod_fit_balanced,
                 color = survey_unit), alpha = 0.6) +
  #confidence intervals for individual GAM
  geom_ribbon(data = year_survey_unit_expand.dt, cols = "year_adj", 
              aes(x = year, ymin=bray_glm_mod_fit_balanced-bray_glm_mod_fit_balanced_SE, ymax=bray_glm_mod_fit_balanced+bray_glm_mod_fit_balanced_SE, fill =  survey_unit), alpha=0.1) + #add standard error
  #set color by survey
    scale_color_manual(values = trend_colors.dt$trend_color, name = "Survey Unit") +
  scale_fill_manual(values =trend_colors.dt$trend_color, guide = "none") +
  theme_classic() +
  lims(x = c(min(distances_dissimilarities_allyears[,year]),max(distances_dissimilarities_allyears[,year]))
       ) +
  xlab("Year\n") +
ylab("Î²-diversity\n(Bray Curtis balanced changes in abundance)") +
  theme(legend.position = "null", axis.text = element_text(size = 15), axis.title = element_text(size = 15))

points_wavylines_bray_curtis_balanced_year_reduced_gam_colorbytrend

ggsave(points_wavylines_bray_curtis_balanced_year_reduced_gam_colorbytrend, path = here::here("figures"), filename ="points_wavylines_bray_curtis_balanced_year_reduced_gam_colorbytrend.jpg", height = 6, width = 11, unit = "in")



```
Bray Curtis gradient changes
```{r color wavy lines by trend Bray Curtis gradient}

points_wavylines_bray_curtis_gradient_year_reduced_gam_colorbytrend <- ggplot() +
  #full LMER predictions (black)
  geom_ribbon(data = lmer_bray_gradient_predictions, aes(x = year, ymin = bray_curtis_lmer_preds_lowerCI, ymax = bray_curtis_lmer_preds_upperCI), fill = "grey", alpha = 0.3) +
    geom_line(data = lmer_bray_gradient_predictions, aes(x = year, y = bray_curtis_lmer_preds), color = "black") +
  #points by trend
  geom_point(data = distances_dissimilarities_allyears, cols = "year_adj",
             aes(x = year,
                 y = bray_curtis_dissimilarity_gradient_mean,
                 fill = survey_unit), alpha = 0.4, size = 1, shape = 21, color = "white") +
  #squiggly lines by survey unit based GAM and colored by trend
    geom_line(data = year_survey_unit_expand.dt, cols = "year_adj",
             aes(x = year,
                 y = bray_glm_mod_fit_gradient,
                 color = survey_unit), alpha = 0.6) +
  #confidence intervals for individual GAM
  geom_ribbon(data = year_survey_unit_expand.dt, cols = "year_adj", 
              aes(x = year, ymin=bray_glm_mod_fit_gradient-bray_glm_mod_fit_gradient_SE, ymax=bray_glm_mod_fit_gradient+bray_glm_mod_fit_gradient_SE, fill =  survey_unit), alpha=0.1) + #add standard error
  #set color by survey
    scale_color_manual(values = trend_colors.dt$trend_color, name = "Survey Unit") +
  scale_fill_manual(values =trend_colors.dt$trend_color, guide = "none") +
  theme_classic() +
  lims(x = c(min(distances_dissimilarities_allyears[,year]),max(distances_dissimilarities_allyears[,year]))
       ) +
  xlab("Year\n") +
ylab("Î²-diversity\n(Bray Curtis abundance gradients)") +
  theme(legend.position = "null", axis.text = element_text(size = 15), axis.title = element_text(size = 15))

points_wavylines_bray_curtis_gradient_year_reduced_gam_colorbytrend

ggsave(points_wavylines_bray_curtis_gradient_year_reduced_gam_colorbytrend, path = here::here("figures"), filename ="points_wavylines_bray_curtis_gradient_year_reduced_gam_colorbytrend.jpg", height = 6, width = 11, unit = "in")



```

###Merge BC versus Year plot with GAMS and Region vs. coefficient plot for LMs

```{r merge lollipop and wiggly lines}
######################################################
##################BCTOTAL
BC_total_GAM_LM_merge_legend_colorbytrend <- ggdraw(xlim = c(0, 40.5), ylim = c(0, 21)) +
    draw_plot(points_wavylines_bray_total_year_reduced_gam_colorbytrend + theme(axis.text = element_text(size = 14)),
                                         x = 1, y = 1, width = 20, height = 20) +
    draw_plot(BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL +
        theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
              axis.text = element_text(size = 8)), #change legend text font size),
                                         x = 20, y = 1, width = 19, height = 20) +
    draw_plot(get_legend(directional_change_legend_plot_colorbytrend + 
      theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=16), #change legend title font size
        legend.text = element_text(size=15))), #change legend text font size)
                                x = 27, y = 8, width = 3, height = 2) +
  geom_text(aes(x = 2, y = 20.7), label = ("a."), size =8, fontface = "bold") +
  geom_text(aes(x =20, y = 20.7), label = ("b."), size =8, fontface = "bold")

ggsave(BC_total_GAM_LM_merge_legend_colorbytrend, path = here::here("figures"), filename = "BC_total_GAM_LM_merge_legend_colorbytrend.png", height = 8, width = 14, units = "in")



######################################################
##################BC BALANCED
BC_balanced_GAM_LM_merge_legend_colorbytrend <- ggdraw(xlim = c(0, 40.5), ylim = c(0, 21)) +
    draw_plot(points_wavylines_bray_curtis_balanced_year_reduced_gam_colorbytrend + theme(axis.text = element_text(size = 14)),
                                         x = 1, y = 1, width = 20, height = 20) +
    draw_plot(BC_balanced_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL +
        theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
              axis.text = element_text(size = 8)), #change legend text font size),
                                         x = 20, y = 1, width = 19, height = 20) +
    draw_plot(get_legend(directional_change_legend_plot_colorbytrend + 
      theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=16), #change legend title font size
        legend.text = element_text(size=15))), #change legend text font size)
                                x = 26, y = 9, width = 3, height = 2) +
  geom_text(aes(x = 2, y = 20.7), label = ("a."), size =8, fontface = "bold") +
  geom_text(aes(x =20, y = 20.7), label = ("b."), size =8, fontface = "bold")

ggsave(BC_balanced_GAM_LM_merge_legend_colorbytrend, path = here::here("figures"), filename = "BC_balanced_GAM_LM_merge_legend_colorbytrend.png", height = 8, width = 14, units = "in")



######################################################
##################BC GRADIENT
BC_gradient_GAM_LM_merge_legend_colorbytrend <- ggdraw(xlim = c(0, 40.5), ylim = c(0, 21)) +
    draw_plot(points_wavylines_bray_curtis_gradient_year_reduced_gam_colorbytrend + theme(axis.text = element_text(size = 14)),
                                         x = 1, y = 1, width = 20, height = 20) +
    draw_plot(BC_gradient_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL +
        theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
              axis.text = element_text(size = 8)), 
                                         x = 20, y = 1, width = 19, height = 20) +
    draw_plot(get_legend(directional_change_legend_plot_colorbytrend + 
      theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=16), #change legend title font size
        legend.text = element_text(size=15))), #change legend text font size)
                                x = 34, y = 6, width = 3, height = 2) +
  geom_text(aes(x = 2, y = 20.7), label = ("a."), size =8, fontface = "bold") +
  geom_text(aes(x =20, y = 20.7), label = ("b."), size =8, fontface = "bold")

ggsave(BC_gradient_GAM_LM_merge_legend_colorbytrend, path = here::here("figures"), filename = "BC_gradient_GAM_LM_merge_legend_colorbytrend.png", height = 8, width = 14, units = "in")



######################################################
##################JACCARDTOTAL
jaccard_total_GAM_LM_merge_legend_colorbytrend <- ggdraw(xlim = c(0, 40.5), ylim = c(0, 21)) +
    draw_plot(points_wavylines_jaccard_total_year_reduced_gam_colorbytrend + theme(axis.text = element_text(size = 14)),
                                         x = 1, y = 1, width = 20, height = 20) +
    draw_plot(jaccard_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend_LINEAR_MODEL +
        theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
              axis.text = element_text(size = 8)), #change legend text font size),
                                         x = 20, y = 1, width = 19, height = 20) +
    draw_plot(get_legend(directional_change_legend_plot_colorbytrend + 
      theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=16), #change legend title font size
        legend.text = element_text(size=15))), #change legend text font size)
                                x = 26, y = 8, width = 3, height = 2) +
  geom_text(aes(x = 2, y = 20.7), label = ("a."), size =8, fontface = "bold") +
  geom_text(aes(x =20, y = 20.7), label = ("b."), size =8, fontface = "bold")

ggsave(jaccard_total_GAM_LM_merge_legend_colorbytrend, path = here::here("figures"), filename = "jaccard_total_GAM_LM_merge_legend_colorbytrend.png", height = 8, width = 14, units = "in")
```


###Is each survey better described by LM or by GAM?
####Also, compile predicted values from GAM
```{r compare lms to gams for each region}

#list of surveys
survey_unit.list <- levels(factor(distances_dissimilarities_allyears$survey_unit))

# Function to compare GAM and linear model fits
compare_models <- function(subset_data) {
  # Fit GAM model with "fs" basis and single smooth term
  gam_model <- gam(bray_curtis_dissimilarity_total_mean ~ s(year, bs = "fs", m = 1), data = subset_data)
  
  # Fit linear model
  lm_model <- lm(bray_curtis_dissimilarity_total_mean ~ year, data = subset_data)
  
  # Calculate AICc values
  aicc_gam <- AICc(gam_model)
  aicc_lm <- AICc(lm_model)
  
  #Calculate p-values
  gam_pvalue <- summary(gam_model)$s.table[1,4]
  lm_pvalue <- summary(lm_model)$coefficients[2,4]
  
  comparison <- ifelse((abs(aicc_gam-aicc_lm) < 2 | (aicc_gam == aicc_lm)),"Same",
                       ifelse(((abs(aicc_gam-aicc_lm) > 2 & (aicc_gam < aicc_lm))),"GAM",
                              ifelse(((abs(aicc_gam-aicc_lm) > 2 & (aicc_gam > aicc_lm))), "Linear",NA)))
  
   return(data.table(Survey = unique(subset_data$Survey_Name_Season)[1],
                     survey_unit = unique(subset_data$survey_unit),
                    comparison = comparison,
                    aicc_gam = aicc_gam,
                    gam_p = gam_pvalue,
                    aicc_lm = aicc_lm,
                    lm_p = lm_pvalue))
}


############## Compare models for each survey name and bind the results
GAM_LM_model_comparisons <- data.table()

for (i in 1:length(survey_unit.list)) {
  GAM_LM_model_comparisons_single <- compare_models(distances_dissimilarities_allyears[survey_unit == survey_unit.list[i]])
  GAM_LM_model_comparisons <- rbind(GAM_LM_model_comparisons, GAM_LM_model_comparisons_single)
}

GAM_LM_model_comparisons

#round to 2 significant figures

#names of numeric columns
numeric_cols <- names(GAM_LM_model_comparisons)[sapply(GAM_LM_model_comparisons, is.numeric)]

# Apply signif() only to numeric columns
GAM_LM_model_comparisons[, (numeric_cols) := lapply(.SD, function(x) if (is.numeric(x)) signif(x, digits = 2) else x), .SDcols = numeric_cols]


View(GAM_LM_model_comparisons)

GAM_LM_model_comparisons.f <- GAM_LM_model_comparisons[,-2]

colnames(GAM_LM_model_comparisons.f) <- c("Survey","Model comparison", "GAM AICc","GAM p-value","LM AICc", "LM p-value")

fwrite(GAM_LM_model_comparisons.f, here::here("output","GAM_LM_model_comparisons.csv"))


##################generate predicted GAM values
GAM_outputs <- function(subset.data) {
# Fit GAM model with "fs" basis and single smooth term
  gam_model <- gam(bray_curtis_dissimilarity_total_mean ~ s(year, bs = "fs", m = 1), data = subset.data)
  
  pred_values <- predict(gam_model, se.fit = T)
  pred_table <- data.table(year = subset.data$year, predicted_dissimilarity = as.numeric(pred_values$fit), predicted_lwr = as.numeric(pred_values$fit)-as.numeric(pred_values$se.fit), predicted_upr = as.numeric(pred_values$fit)+as.numeric(pred_values$se.fit))
  
  st_dev_pred_dissim <- sd(pred_table$predicted_dissimilarity)
  return(signif(st_dev_pred_dissim,2))
}

predicted_values <- data.table(survey_unit = survey_unit.list, SD_pred_dissim = as.numeric())

for (i in 1:length(survey_unit.list)) {
  st_dev_pred_dissim <- GAM_outputs(distances_dissimilarities_allyears[survey_unit == survey_unit.list[i]])
  predicted_values[i,"SD_pred_dissim"] <- st_dev_pred_dissim
}

#merge witih GAM vs LM

GAM_lm_SD <- predicted_values[GAM_LM_model_comparisons, on = "survey_unit"]

GAM_lm_SD.f <- GAM_lm_SD[,.(Survey, SD_pred_dissim, aicc_gam, gam_p, aicc_lm, lm_p, comparison)]

colnames(GAM_lm_SD.f) <- c("Survey","SD over time of predicted GAM values", "GAM AICc","GAM p-value","LM AICc", "LM p-value","Model comparison")

View(GAM_lm_SD.f)

fwrite(GAM_lm_SD.f, here::here("output","GAM_lm_SD.f.csv"))

```


Comparison plots
Plot each bray curtis total independently 

Note that this is for independent linear models and independent generalized additive models, NOT models built for all surveys at once
```{r plot each independently}
#plot each independently for supplement
#all survey names = 
all_survey_names <- color_link_trend$survey_unit

#set order of levels of Survey Name Season by survey unit
distances_dissimilarities_allyears[,Survey_Name_Season := factor(Survey_Name_Season, levels = trend_colors.dt$Survey_Name_Season, ordered = T)]

#change year to integer
distances_dissimilarities_allyears[,year:=as.integer(year)]

#split into 2 and use facet
#first 24
points_wavylines_bray_total_year_reduced_gam_colorbytrend_individual_facet_1_24 <- ggplot() +
  geom_point(data = distances_dissimilarities_allyears[survey_unit  %in% all_survey_names[c(1:24)]],
             aes(x = as.integer(year),
                 y = bray_curtis_dissimilarity_total_mean), alpha = 0.3) +

    geom_smooth(data = distances_dissimilarities_allyears[survey_unit  %in% all_survey_names[c(1:24)]],
             aes(x = as.integer(year),
                 y = bray_curtis_dissimilarity_total_mean,
                 color = survey_unit,
                 fill = survey_unit), method = "lm", linewidth = 0.5) +
  geom_smooth(data = distances_dissimilarities_allyears[survey_unit %in% all_survey_names[c(1:24)]],
              aes(x = as.integer(year),
                  y = bray_curtis_dissimilarity_total_mean), method = "gam", linewidth = 0.5, formula = y ~ s(x, bs = "fs", m = 1), color = "black") +
    scale_color_manual(values =    color_link_trend$trend_color[1:24], name = "Survey Unit") +
    scale_fill_manual(values =    color_link_trend$trend_color[1:24], name = "Survey Unit") +
  scale_x_continuous(breaks = ~ axisTicks(., log = FALSE)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 7)) +
  xlab("Year") +
ylab("Î²-diversity") +
  facet_wrap(~Survey_Name_Season, ncol = 4, scales = "free") +
  theme(axis.text = element_text(size = 8), axis.title = element_text(size = 12), legend.position = "null")

ggsave(points_wavylines_bray_total_year_reduced_gam_colorbytrend_individual_facet_1_24, path =  here::here("figures"), filename = "points_wavylines_bray_total_year_reduced_gam_colorbytrend_individual_facet_1_24.png", height = 12, width = 9.5)

#second portion
points_wavylines_bray_total_year_reduced_gam_colorbytrend_individual_facet_25_42 <- ggplot() +
  geom_point(data = distances_dissimilarities_allyears[survey_unit  %in% all_survey_names[c(25:42)]],
             aes(x = as.integer(year),
                 y = bray_curtis_dissimilarity_total_mean), alpha = 0.3) +

    geom_smooth(data = distances_dissimilarities_allyears[survey_unit  %in% all_survey_names[c(25:42)]],
             aes(x = as.integer(year),
                 y = bray_curtis_dissimilarity_total_mean,
                 color = survey_unit,
                 fill = survey_unit), method = "lm", linewidth = 0.5) +
  geom_smooth(data = distances_dissimilarities_allyears[survey_unit %in% all_survey_names[c(25:42)]],
              aes(x = as.integer(year),
                  y = bray_curtis_dissimilarity_total_mean), method = "gam", linewidth = 0.5, formula = y ~ s(x, bs = "fs", m = 1), color = "black") +
    scale_color_manual(values =    color_link_trend$trend_color[25:42], name = "Survey Unit") +
    scale_fill_manual(values =    color_link_trend$trend_color[25:42], name = "Survey Unit") +
  scale_x_continuous(breaks = ~ axisTicks(., log = FALSE)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 7)) +
  xlab("Year") +
ylab("Î²-diversity") +
  facet_wrap(~Survey_Name_Season, ncol = 4, scales = "free") +
  theme(axis.text = element_text(size = 8), axis.title = element_text(size = 12), legend.position = "null")

ggsave(points_wavylines_bray_total_year_reduced_gam_colorbytrend_individual_facet_25_42, path =  here::here("figures"), filename = "points_wavylines_bray_total_year_reduced_gam_colorbytrend_individual_facet_25_42.png", height = 12, width = 9.5)


```


























#################################################
SCRATCH OLD CODE



###Move forward with Bray Curtis total (others to supplement, although will include in plot below)

Coefficients for LMER by survey_unit
```{r}
#unique survey unit year combos
survey_unit_sampling_years <- unique(distances_dissimilarities_allyears[,.(survey_unit, year_adj, year, years_sampled)])

#just # years
survey_unit_years <- unique(survey_unit_sampling_years[,.(survey_unit, years_sampled)])

# see group coefficients
model_coefs_reduced <- data.table(transform(as.data.frame(ranef(bray_curtis_total_lmer)), lwr = condval - 1.96*condsd, upr = condval + 1.96*condsd))
#https://stackoverflow.com/questions/69805532/extract-the-confidence-intervals-of-lmer-random-effects-plotted-with-dotplotra


#ONLY SLOPES
model_coefs_reduced <- model_coefs_reduced[term == "year_adj",]

model_coefs_reduced[,survey_unit := grp][,year_adj := condval]

#merge with duration of survey
model_coefs_reduced_length <- model_coefs_reduced[survey_unit_sampling_years, on = "survey_unit"]


model_coefs_reduced_length[,years_sampled := as.numeric(years_sampled)][,Directional_Change := ifelse(year_adj > 0, "Differentiation","Homogenization")]

#does it cross zero?
model_coefs_reduced_length[,significant := ifelse(lwr >0 & upr>0,T,ifelse(lwr<0 & upr<0,T,F))]

#significant directional change
model_coefs_reduced_length[,Directional_Change_sig := ifelse(year_adj > 0 & significant == T, "Differentiation",ifelse(year_adj < 0 & significant == T, "Homogenization", "No trend in\ndissimilarity"))]


#min max distances_dissimilarities
min_bray_reduced <- min(distances_dissimilarities_allyears[,bray_curtis_dissimilarity_total_mean], na.rm = T)
max_bray_reduced <- max(distances_dissimilarities_allyears[,bray_curtis_dissimilarity_total_mean], na.rm = T)

model_coefs_reduced_length <- model_coefs_reduced_length[color_link, on = "survey_unit"]

#delete any NAs
model_coefs_reduced_length <- na.omit(model_coefs_reduced_length, cols = "significant")

#order table by coefficient
setorder(model_coefs_reduced_length, year_adj)

BC_total_model_coefs_reduced_length.unique <- unique(model_coefs_reduced_length[,.(condval,condsd, lwr, upr, survey_unit, year_adj, years_sampled, Directional_Change, hex, Survey_Name_Season, significant, Directional_Change_sig)]) 

#extract color hexes
#year adj coef order
color_year_adj_order <- BC_total_model_coefs_reduced_length.unique[,hex]

#alphabetical order
BC_total_model_coefs_reduced_length.unique.alpha <- setorder(BC_total_model_coefs_reduced_length.unique, Survey_Name_Season)

BC_total_model_coefs_reduced_length.unique.alpha[,trend_color := ifelse(Directional_Change_sig == "Homogenization", "#e7ac5b", ifelse(Directional_Change_sig == "Differentiation","#91c874","#D81C60"))]

color_alpha_order <- BC_total_model_coefs_reduced_length.unique.alpha[,hex]
color_alpha_order_bytrend <- BC_total_model_coefs_reduced_length.unique.alpha[, trend_color]

#key trend color and survey
trend_color_survey <- unique(BC_total_model_coefs_reduced_length.unique.alpha[,.(survey_unit, Survey_Name_Season,hex, trend_color)])

saveRDS(BC_total_model_coefs_reduced_length.unique, here::here("output","region_stats","BC_total_model_coefs_reduced_length.unique.Rds"))
```


These bar plots show LMER random slope and intercept and use alternate color schemes
```{r bar plot of coefficients}
BC_total_Dissimilarity_Coef_errorbar_reduced <- ggplot() +
    geom_errorbar(data = model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, year_adj) , y = year_adj, label = Survey_Name_Season, ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(data = model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, year_adj) , y = year_adj, label = Survey_Name_Season, size = years_sampled, fill = Directional_Change_sig, color = Directional_Change_sig), stat = 'identity', shape = 21) +
  scale_fill_manual(values = c("white","black","grey"), name = "Dissimilarity trend", guide="none") +
  scale_color_manual(values = c("black","black","grey"), name = "Dissimilarity trend", guide="none") +
  scale_size_binned(range = c(1,8), name = "Survey period length\n(years)") +
  geom_hline(yintercept = 0) +
  scale_y_continuous(breaks = seq(-0.005, 0.0075, by = 0.0025), labels = c("-0.005","","0", "", "0.005",  "")) +
  xlab("Survey unit") +
  ylab("Î²-diversity trend") + #total BC dissimilarity trend
  coord_flip() +
  theme_classic() +
  theme(axis.text.y = element_text(colour = color_year_adj_order, face = "bold"), axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.title.x = element_text(size = 15), legend.position = c(0.25,0.7), legend.direction = "vertical")

#pull legend for homogenization
directional_change_legend_plot <- BC_total_Dissimilarity_Coef_errorbar_reduced + 
  scale_fill_manual(values = c("white","black","grey"), name = "Dissimilarity trend") +
  scale_color_manual(values = c("black","black","grey"), name = "Dissimilarity trend") +
  scale_size_binned(range = c(1,8), name = "Survey period length", guide = "none") +
  theme(legend.position = "right", legend.background = element_rect(fill= "transparent")) +
  guides(colour = guide_legend(override.aes = list(size=6)))


BC_total_Dissimilarity_Coef_errorbar_reduced

#ALT grey scale
BC_total_Dissimilarity_Coef_errorbar_reduced_greyscale <- ggplot() +
    geom_errorbar(data = model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, year_adj) , y = year_adj, label = Survey_Name_Season, ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(data = model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, year_adj) , y = year_adj, label = Survey_Name_Season, size = years_sampled, fill = Directional_Change_sig, color = Directional_Change_sig), stat = 'identity', shape = 21) +
  scale_fill_manual(values = c("white","black","grey"), name = "Dissimilarity trend", guide="none") +
  scale_color_manual(values = c("black","black","grey"), name = "Dissimilarity trend", guide="none") +
  scale_size_binned(range = c(1,8), name = "Survey period length\n(years)") +
  geom_hline(yintercept = 0) +
  scale_y_continuous(breaks = seq(-0.005, 0.0075, by = 0.0025), labels = c("-0.005","","0", "", "0.005",  "")) +
  xlab("Survey unit") +
  ylab("Î²-diversity trend") + #total BC dissimilarity trend
  coord_flip() +
  theme_classic() +
  theme(axis.text.y = element_text(face = "bold"), axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.title.x = element_text(size = 15), legend.position = c(0.25,0.7), legend.direction = "vertical")

#"#FFC109","#1E88E5","#D81C60"

BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend <- ggplot() +
    geom_errorbar(data = model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, year_adj) , y = year_adj, label = Survey_Name_Season, ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(data = model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, year_adj) , y = year_adj, label = Survey_Name_Season, size = years_sampled, color = Directional_Change_sig), stat = 'identity') +
  scale_color_manual(values = c("#FFC109","#1E88E5","#D81C60"), name = "Dissimilarity trend", guide="none") +
  scale_size_binned(range = c(1,8), name = "Survey period length\n(years)") +
  geom_hline(yintercept = 0) +
  scale_y_continuous(breaks = seq(-0.005, 0.0075, by = 0.0025), labels = c("-0.005","","0", "", "0.005",  "")) +
  xlab("Survey unit") +
  ylab("Î²-diversity trend") + #total BC dissimilarity trend
  coord_flip() +
  theme_classic() +
  theme(axis.text.y = element_text(face = "bold"), axis.title.y = element_blank(), axis.text.x = element_text(size = 15), axis.title.x = element_text(size = 15), legend.position = c(0.3,0.8), legend.direction = "vertical", legend.text = element_text(size = 15), legend.title = element_text(size = 16))

directional_change_legend_plot_colorbytrend <- BC_total_Dissimilarity_Coef_errorbar_reduced_colorbytrend + 
  theme(legend.position = "right", legend.background = element_rect(fill= "transparent"), 
         legend.text = element_text(size = 15), legend.title = element_text(size = 16)) +
  guides(colour = guide_legend(override.aes = list(size=6)), size = "none")
```


Merge BC versus Year plot with GAMS and Region vs. coefficient plot for LMs

```{r}

BC_total_GAM_LMER_merge_legend <- ggdraw(xlim = c(0, 40.5), ylim = c(0, 21)) +
    draw_plot(points_wavylines_bray_total_year_reduced_gam_colorbytrend,
                                         x = 1, y = 1, width = 20, height = 20) +
    draw_plot(BC_total_Dissimilarity_Coef_errorbar_reduced +
        theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=16), #change legend title font size
        legend.text = element_text(size=14)), #change legend text font size),
                                         x = 20, y = 1, width =19, height = 20) +
    draw_plot(get_legend(directional_change_legend_plot + 
      theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=15), #change legend title font size
        legend.text = element_text(size=13))), #change legend text font size)
                                       x = 27, y = 10, width = 3, height = 2) +
  geom_text(aes(x = 2, y = 20.7), label = ("a."), size =8, fontface = "bold") +
  geom_text(aes(x =20, y = 20.7), label = ("b."), size =8, fontface = "bold")


ggsave(BC_total_GAM_LMER_merge_legend, path = here::here("figures"), filename = "BC_total_GAM_LMER_merge_legend.png", height = 8, width = 14, units = "in")

#ALT GREY SCALE
BC_total_GAM_LMER_merge_legend_greyscale <- ggdraw(xlim = c(0, 40.5), ylim = c(0, 21)) +
    draw_plot(points_wavylines_bray_total_year_reduced_gam_colorbytrend_greyscale,
                                         x = 1, y = 1, width = 20, height = 20) +
    draw_plot(BC_total_Dissimilarity_Coef_errorbar_reduced_greyscale +
        theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=16), #change legend title font size
        legend.text = element_text(size=14)), #change legend text font size),
                                         x = 20, y = 1, width = 19, height = 20) +
    draw_plot(get_legend(directional_change_legend_plot + 
      theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.title = element_text(size=15), #change legend title font size
        legend.text = element_text(size=13))), #change legend text font size)
                                x = 27, y = 10, width = 3, height = 2) +
  geom_text(aes(x = 2, y = 20.7), label = ("a."), size =8, fontface = "bold") +
  geom_text(aes(x =20, y = 20.7), label = ("b."), size =8, fontface = "bold")

ggsave(BC_total_GAM_LMER_merge_legend_greyscale, path = here::here("figures"), filename = "BC_total_GAM_LMER_merge_legend_greyscale.png", height = 8, width = 14, units = "in")
```

