---
title: "Annual Balanced BC Dissimilarity vs. OISST Temperature for all Survey Units"
output: html_notebook
---

This code is Script X for Kitchel et al. TITLE manuscript.

- This project is a collaborative effort to describe changes in taxonomic composition  of fish communities around the world--as sampled by bottom trawl surveys.

- Code by Zoë J. Kitchel

SESSION INFO TO DO

##Here, we try to use temperature to predict annual dissimilarity for all survey units

```{r setup}

library(data.table)
library(ggplot2)
library(lme4)
library(lmerTest)
library(MuMIn)


OISST_data_temp_avgs_full <- readRDS(here::here("data","Temperature","OISST_data_temp_avgs_full.rds"))

OISST_data_temp_avgs_full[,year := year_for_avg]

#pull in average distance decay values
distances_dissimilarities_allyears.r <- readRDS(here::here("output","distance_decay","distances_dissimilarities_allyears.r.rds"))

#pull in regional statistics
region_stats <- readRDS(here::here("output","region_stats", "region_stats.rds"))

```

Put into one data table
```{r link temp to avg values}
dissimilarities_temp <- OISST_data_temp_avgs_full[distances_dissimilarities_allyears.r, on = c("year","survey_unit")]
```

###Palette for Plotting
Palette for plotting all 37 survey units
```{r link colors to survey units}
survey_unit.list <- levels(distances_dissimilarities_allyears.r[,factor(survey_unit)])

palette_37 <- c(
  "#5A5156", #AI
  "#F6222E", #CHL
  "#F8A19F", #DFO-NF
  "#16FF32", #DFO-QCS
  "#DF00DB", #BITS-1
  "#DB8EDA", #BITS-4
  "#325A9B", #EBS
  "#3283FE", #EVHOE
  "#FEAF16", #FR-CGFS
  "#1C8356", #GMEX-Summer
  "#C4451C", #GOA
  "#85660D", #GRL-DE
  "#B0009F", #GSL-N
  "#BF79B8", #GSL-S
  "#1CBE4F", #ICE-GFS
  "#782AB6", #IE-IGFS
  "#90AD1C", #MEDITS
  "#6B003A", #NAM
  "#A75B00", #NEUS-Fall
  "#E3B072", #NEUS-Spring
  "#02E8B6", #NIGFS-1
  "#97E7D5", #NIGFS-4
  "#B00068", #Nor-BTS-3
  "#00B9E3", #NS-IBTS-1
  "#95E2F4", #NS-IBTS-3
  "#B3CE73", #NZ-CHAT
  "#689500", #NZ-ECSI
  "#AAF400", #NZ-WCSI
  "#AA0DFE", #PT-IBTS
  "#FA0087", #S-GEORG
  "#DEA0FD", #SCS-Summer
  "#FCEF88", #SEUS-fall
  "#A59405", #SEUS-spring
  "#FCE100", #SEUS-summer
  "#C075A6", #WCANN
  "#BDCDFF", #ZAF-ATL
  "#003EFF"  #ZAF-IND
)

color_link <- data.table(survey_unit = survey_unit.list,hex = palette_37)
```

Add names for plotting
```{r add names for plotting}

name_helper <- data.table(Survey_Name_Season = c("Aleutian Islands",
                                    "Baltic Sea Q1",
                                    "Baltic Sea Q4",
                                    "Chile",
                                    "Newfoundland",
                                    "Queen Charlotte Sound",
                                    "Eastern Bering Sea",
                                    "Bay of Biscay",
                                    "English Channel",
                                    "Gulf of Mexico",
                                    "Gulf of Alaska",
                                    "Greenland",
                                    "N Gulf of St. Lawrence",
                                    "S Gulf of St. Lawrence",
                                    "Iceland",
                                    "Irish Sea",
                                    "Mediterranean",
                                    "Namibia",
                                    "NE US Fall",
                                    "NE US Spring",
                                    "N Ireland Q1",
                                    "N Ireland Q4",
                                    "Norway",
                                    "N Sea Q1",
                                    "N Sea Q3",
                                    "Chatham Rise",
                                    "E Coast S Island NZ",
                                    "W Coast S Island NZ",
                                    "Portugal",
                                    "S Georgia Straight",
                                  "Scotian Shelf",
                                  "SE US Fall",
                                  "SE US Spring",
                                  "SE US Summer",
                                  "W Coast US",
                                  "Atlantic Ocean ZA",
                                  "Indian Ocean ZA"),
                          survey_unit = c(
                                  "AI",        
                                  "BITS-1",    
                                  "BITS-4",    
                                  "CHL",       
                                  "DFO-NF",    
                                  "DFO-QCS",   
                                  "EBS",       
                                  "EVHOE",     
                                  "FR-CGFS",   
                                  "GMEX-Summer",
                                  "GOA",       
                                  "GRL-DE",    
                                  "GSL-N",     
                                  "GSL-S",     
                                  "ICE-GFS",   
                                  "IE-IGFS",   
                                  "MEDITS",    
                                  "NAM",       
                                  "NEUS-Fall", 
                                  "NEUS-Spring",
                                  "NIGFS-1",   
                                  "NIGFS-4",   
                                  "Nor-BTS-3", 
                                  "NS-IBTS-1", 
                                  "NS-IBTS-3", 
                                  "NZ-CHAT",   
                                  "NZ-ECSI",   
                                  "NZ-WCSI",   
                                  "PT-IBTS",   
                                  "S-GEORG",   
                                  "SCS-SUMMER",
                                  "SEUS-fall", 
                                  "SEUS-spring",
                                  "SEUS-summer",
                                  "WCANN",     
                                  "ZAF-ATL",   
                                  "ZAF-IND"   
                          ))

color_link <- color_link[name_helper, on = "survey_unit"]

```

Table that will be populated with model results
```{r}
#depth, scaled, temp var, coefficient, p-value, marg_r^2, cond_r^2, AICc
balanced_dissimilarity_sst_model_results <- data.table(Depth = as.character(),
                                                       Scaled = as.character(),
                                                       `Temp variable` = as.character(),
                                                       Intercept = as.numeric(),
                                                       `Temp coefficient` = as.numeric(),
                                                       `Coefficient p-value` = as.numeric(),
                                                       `Marginal R-squared` = as.numeric(),
                                                       `Conditional R-squared` = as.numeric(),
                                                       AICc = as.numeric(),
                                                       `Degrees of freedom`=as.numeric())
                                                  
```


How does this trend hold up for all regions?
###UNSCALED

####Mean temperature
```{r mean sst}
#for all regions
(dissimilarity_BC_balanced_sst_mean <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_mean, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_mean_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_mean_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_mean_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_avg + (1 + yearly_mean_bypoint_avg|survey_unit), data = dissimilarities_temp) #this converges (allows both intercept and slope to vary with survey_unit)

summary(dissimilarity_BC_balanced_sst_mean_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_mean_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_mean_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 F, #scaled
                                                 "mean", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_mean_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_mean_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_mean_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_mean_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_mean_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom (NOT SURE ABOUT THIS)
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)
```

####Min temperature
```{r min sst}
#for all regions
(dissimilarity_BC_balanced_sst_min <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_min, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_min.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_min_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_min_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_min_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_min_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_avg + (1 + yearly_min_bypoint_avg|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_min_mod) #insignificant relationship


confint <- confint(dissimilarity_BC_balanced_sst_min_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_min_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 F, #scaled
                                                 "min", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_min_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_min_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_min_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_min_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_min_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)
```

####Max sst
```{r max sst}
#for all regions
(dissimilarity_BC_balanced_sst_max <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_max, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_max.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_max_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_max_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_max_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_max_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_avg + (1 + yearly_max_bypoint_avg|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_max_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_max_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_max_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 F, #scaled
                                                 "max", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_max_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_max_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_max_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_max_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_max_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)

```

####Seas sst
```{r seas sst}
#for all regions
(dissimilarity_BC_balanced_sst_seas <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_seas, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seas.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_seas_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seas_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seas_facet.jpg", height = 10, width = 11, unit = "in")


dissimilarity_BC_balanced_sst_seas_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_avg + (1 + yearly_seas_bypoint_avg|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_seas_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_seas_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_seas_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 F, #scaled
                                                 "seas", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_seas_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_seas_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_seas_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_seas_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_seas_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)

```

###Standard deviation of grid cells
####Mean temperature SD
```{r mean sst SD}
#for all regions
(dissimilarity_BC_balanced_sst_meanSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_meanSD, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_meanSD.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_meanSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_meanSD_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_meanSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_meanSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_SD + (1 + yearly_mean_bypoint_SD|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_meanSD_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_meanSD_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_meanSD_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 F, #scaled
                                                 "meanSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_meanSD_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_meanSD_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_meanSD_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_meanSD_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_meanSD_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)


```

####Min temperature SD
```{r min sst SD}
#for all regions
(dissimilarity_BC_balanced_sst_minSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_minSD, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_minSD.jpg", height = 4, width = 9, unit = "in") 

#faceted
dissimilarity_BC_balanced_sst_minSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_minSD_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_minSD_facet.jpg", height = 10, width = 11, unit = "in")


dissimilarity_BC_balanced_sst_minSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_SD + (1 + yearly_min_bypoint_SD|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_minSD_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_minSD_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_minSD_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 F, #scaled
                                                 "minSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_minSD_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_minSD_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_minSD_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_minSD_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_minSD_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)
```

####Max sst SD
```{r max sst SD}
#for all regions
dissimilarity_BC_balanced_sst_maxSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_maxSD, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_maxSD.jpg", height = 4, width = 9, unit = "in") 

#faceted
dissimilarity_BC_balanced_sst_maxSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_maxSD_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_maxSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_maxSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_SD + (1 + yearly_max_bypoint_SD|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_maxSD_mod) #significant relationship (0.02)

confint <- confint(dissimilarity_BC_balanced_sst_maxSD_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_maxSD_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 F, #scaled
                                                 "maxSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_maxSD_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_maxSD_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_maxSD_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_maxSD_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_maxSD_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)

```

####Seas sst SD
```{r seas sst SD}
#for all regions
(dissimilarity_BC_balanced_sst_seasSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_seasSD, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seasSD.jpg", height = 4, width = 9, unit = "in")

#faceted
dissimilarity_BC_balanced_sst_seasSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seasSD_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seasSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_seasSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_SD + (1 + yearly_seas_bypoint_SD|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_seasSD_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_seasSD_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_seasSD_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 F, #scaled
                                                 "seasSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_seasSD_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_seasSD_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_seasSD_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_seasSD_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_seasSD_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)



```


###Raw temp values: Comparing temperature predictors for raw
```{r compare raw temp predictors}

setorder(balanced_dissimilarity_sst_model_results,AICc)
balanced_dissimilarity_sst_model_results


```
The raw mean temperature in the 12 months before a survey is the best predictor.

As the raw mean temp 12 months before a survey increases, the dissimilarity also increases (0.004 * ˚C). Warmer ecosystems are more heterogenous in community structure.

---
##SCALED
###Avg of grid cells
####Mean temperature scaled
```{r mean sst scaled}
#for all regions
dissimilarity_BC_balanced_sst_mean_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_mean_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_mean_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_avg.s + (1 + yearly_mean_bypoint_avg.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_mean_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_mean_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_mean_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 T, #scaled
                                                 "mean", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_mean_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_mean_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_mean_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_mean_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_mean_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)
```

####Min temperature scaled
```{r min sst scaled}
#for all regions
dissimilarity_BC_balanced_sst_min_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_min_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_min_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_min_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_avg.s + (1 + yearly_min_bypoint_avg.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_min_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_min_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_min_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 T, #scaled
                                                 "min", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_min_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_min_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_min_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_min_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_min_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)
```

####Max sst scaled
```{r max sst scaled}
#for all regions
dissimilarity_BC_balanced_sst_max_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_max_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_max_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_max_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_avg.s + (1 + yearly_max_bypoint_avg.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_max_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_max_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_max_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 T, #scaled
                                                 "max", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_max_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_max_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_max_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_max_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_max_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)

```

####Seas sst scaled
```{r seas sst scaled}
#for all regions
dissimilarity_BC_balanced_sst_seas_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seas_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seas_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_seas_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_avg.s + (1 + yearly_seas_bypoint_avg.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_seas_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_seas_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_seas_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 T, #scaled
                                                 "seas", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_seas_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_seas_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_seas_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_seas_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_seas_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)

```
###Standard deviation of grid cells
####Mean temperature SD scaled
```{r mean sst SD scaled}
#for all regions
(dissimilarity_BC_balanced_sst_meanSD_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_meanSD_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_meanSD_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_meanSD_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_SD.s + (1 + yearly_mean_bypoint_SD.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_meanSD_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_meanSD_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_meanSD_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 T, #scaled
                                                 "meanSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_meanSD_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_meanSD_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_meanSD_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_meanSD_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_meanSD_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)
```

####Min temperature SD scaled
```{r min sst SD scaled}
#for all regions
dissimilarity_BC_balanced_sst_minSD_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_minSD_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_minSD_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_minSD_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_SD.s + (1 + yearly_min_bypoint_SD.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_minSD_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_minSD_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_minSD_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 T, #scaled
                                                 "minSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_minSD_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_minSD_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_minSD_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_minSD_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_minSD_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)
```

####Max sst SD scaled
```{r max sst SD scaled}
#for all regions
dissimilarity_BC_balanced_sst_maxSD_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_maxSD_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_maxSD_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_maxSD_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_SD.s + (1 + yearly_max_bypoint_SD.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_maxSD_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_maxSD_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_maxSD_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 T, #scaled
                                                 "maxSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_maxSD_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_maxSD_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_maxSD_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_maxSD_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_maxSD_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)

```

####Seas sst SD scaled
```{r seas sst SD scaled}
#for all regions
dissimilarity_BC_balanced_sst_seasSD_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seasSD_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seasSD_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_seasSD_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_SD.s + (1 + yearly_seas_bypoint_SD.s|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_seasSD_scaled_mod) #insignificant relationship

confint <- confint(dissimilarity_BC_balanced_sst_seasSD_scaled_mod) #confidence interval

coefs <- data.frame(coef(summary(dissimilarity_BC_balanced_sst_seasSD_scaled_mod))) #table with coefficients, #Satterthwaite's degrees of freedom, and p-value approximation for fixed effects

#input results into table
balanced_dissimilarity_sst_model_results_row <- data.table(matrix(c("sst", #depth
                                                 T, #scaled
                                                 "seasSD", #temp var
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_seasSD_scaled_mod)[[1]],3),
                                                        " ± ",
                                                        round((confint[5,2]-confint[5,1])/2,3)), #intercept
                                                 paste0(round(fixef(dissimilarity_BC_balanced_sst_seasSD_scaled_mod)[[2]],3),
                                                        " ± ",
                                                        round((confint[6,2]-confint[6,1])/2,3)), #coef
                                                 round(coefs[2,5],3), #pvalue
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_seasSD_scaled_mod)[1],3),#mar r squared
                                                 round(r.squaredGLMM(dissimilarity_BC_balanced_sst_seasSD_scaled_mod)[2],3),#cond r squared
                                                 round(AICc(dissimilarity_BC_balanced_sst_seasSD_scaled_mod),3),#AICc
                                                 round(coefs[2,3],3)#Deg of freedom
                                                 ),nrow = 1))

#merge with larger table
balanced_dissimilarity_sst_model_results <- rbind(balanced_dissimilarity_sst_model_results,balanced_dissimilarity_sst_model_results_row, use.names = F)

```



###Comparing scaled temperature predictors
```{r compare scaled temp predictors}

balanced_dissimilarity_sst_model_results[Scaled == T,]



#for all temp mods, almost nothing is described by scaled temp in region (0.05% of variation), most described by survey unit (90% of variation)
```
Relative mean temperature for the 12 months before survey is the best predictor. As temp increases, dissimilarity increases. Relatively warm years are more heterogenous. 
----
##UNSCALED TEMP AND SCALED DISSIMILARITY. (not sure it makes sense to scale dissimilarity, but worth a shot)

*Can't get any of these to converge, skip for now

Scale dissimilarity within region (hopefully this will make baseline dissimilarity drop out)
```{r}
dissimilarities_temp[,bray_curtis_dissimilarity_balanced_mean.s := scale(bray_curtis_dissimilarity_balanced_mean), survey_unit]
```


####Mean temperature
```{r mean sst scaled dissim}
#for all regions
dissimilarity_BC_balanced_sst_mean_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_mean_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_mean_facet_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean.s), alpha = 0.3) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_mean_facet_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean_facet_dissim_scaled.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_mean_mod_dissim_scaled <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_mean_bypoint_avg + (1|survey_unit), data = dissimilarities_temp, REML = T)

summary(dissimilarity_BC_balanced_sst_mean_mod_dissim_scaled) #insignificant relationship
```

####Min temperature
```{r min sst scaled dissim}
#for all regions
dissimilarity_BC_balanced_sst_min <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_min, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_min.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_min_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_min_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_min_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_min_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_min_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_avg + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_min_mod) #nearly significant relationship (0.09)
```

####Max sst
```{r max sst scaled dissim}
#for all regions
dissimilarity_BC_balanced_sst_max <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_max, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_max.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_max_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_max_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_max_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_max_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_max_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_avg + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_max_mod) #nearly significant relationship (0.51)

```

####Seas sst
```{r seas sst scaled dissim}
#for all regions
dissimilarity_BC_balanced_sst_seas <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seas, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seas.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_seas_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seas_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seas_facet.jpg", height = 10, width = 11, unit = "in")


dissimilarity_BC_balanced_sst_seas_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_avg + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_seas_mod) #nearly significant relationship (0.08)

```

###Standard deviation of grid cells
####Mean temperature SD
```{r mean sst SD scaled dissim}
#for all regions
dissimilarity_BC_balanced_sst_meanSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_meanSD, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_meanSD.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_meanSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_meanSD_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_meanSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_meanSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_mean_bypoint_SD + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_meanSD_mod) #insignificant relationship
```

####Min temperature SD
```{r min sst SD scaled dissim}
#for all regions
dissimilarity_BC_balanced_sst_minSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_minSD, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_minSD.jpg", height = 4, width = 9, unit = "in") 

#faceted
dissimilarity_BC_balanced_sst_minSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_min_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_minSD_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_minSD_facet.jpg", height = 10, width = 11, unit = "in")


dissimilarity_BC_balanced_sst_minSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_min_bypoint_SD + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_minSD_mod) #insignificant relationship
```

####Max sst SD
```{r max sst SD scaled dissim}
#for all regions
dissimilarity_BC_balanced_sst_maxSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_maxSD, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_maxSD.jpg", height = 4, width = 9, unit = "in") 

#faceted
dissimilarity_BC_balanced_sst_maxSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_max_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_maxSD_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_maxSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_maxSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_max_bypoint_SD + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_maxSD_mod) #significant relationship (0.002)

```

####Seas sst SD
```{r seas sst SD scaled dissim}
#for all regions
dissimilarity_BC_balanced_sst_seasSD <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seasSD, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seasSD.jpg", height = 4, width = 9, unit = "in") 

#faceted
dissimilarity_BC_balanced_sst_seasSD_facet <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature SD (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.3) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD, y = bray_curtis_dissimilarity_balanced_mean), method = "lm") +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seasSD_facet, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seasSD_facet.jpg", height = 10, width = 11, unit = "in")

dissimilarity_BC_balanced_sst_seasSD_mod <- lmer(bray_curtis_dissimilarity_balanced_mean ~ yearly_seas_bypoint_SD + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_seasSD_mod) #insignificant relationship

```


###Raw temp values: Comparing temperature predictors for raw
```{r compare raw temp predictors with scaled dissim}

raw_mods_AICc <- AICc(dissimilarity_BC_balanced_sst_maxSD_mod , dissimilarity_BC_balanced_sst_meanSD_mod,
dissimilarity_BC_balanced_sst_max_mod  ,  dissimilarity_BC_balanced_sst_minSD_mod, 
dissimilarity_BC_balanced_sst_seas_mod ,  dissimilarity_BC_balanced_sst_seasSD_mod,
dissimilarity_BC_balanced_sst_min_mod  ,  dissimilarity_BC_balanced_sst_mean_mod) #compare all_mods

#best mods: 
r.squaredGLMM(dissimilarity_BC_balanced_sst_maxSD_mod) #best (delta AICc = 6.5), p = 0.002
summary(dissimilarity_BC_balanced_sst_maxSD_mod)
r.squaredGLMM(dissimilarity_BC_balanced_sst_seasSD_mod) # p = 0.002
summary(dissimilarity_BC_balanced_sst_seasSD_mod)
r.squaredGLMM(dissimilarity_BC_balanced_sst_minSD_mod)# p = 0.04
summary(dissimilarity_BC_balanced_sst_minSD_mod)
r.squaredGLMM(dissimilarity_BC_balanced_sst_max_mod) #p = 0.04
summary(dissimilarity_BC_balanced_sst_max_mod)
#for all temp mods, almost nothing is described by temp (best model, 3% of variation), most described by survey unit (90%)
```

----
##SCALED TEMP AND SCALED DISSIMILARITY
###Avg of grid cells
####Mean temperature scaled and dissimilarity scaled
```{r mean sst scaled and dissim scaled}
#for all regions
dissimilarity_BC_balanced_sst_mean_scaled_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity scaled by reg") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_mean_scaled_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean_scaled_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_mean_scaled_dissim_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_mean_bypoint_avg.s + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_mean_scaled_dissim_scaled_mod) #significant relationship
```

####Min temperature scaled
```{r min sst scaled and dissim scaled}
#for all regions
dissimilarity_BC_balanced_sst_min_scaled_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_min_scaled_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_min_scaled_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_min_scaled_dissim_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_min_bypoint_avg.s + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_min_scaled_dissim_scaled_mod) #significant relationship (0.09)
```

####Max sst scaled
```{r max sst scaled and dissim scaled}
#for all regions
dissimilarity_BC_balanced_sst_max_scaled_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_max_scaled_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_max_scaled_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_max_scaled_dissim_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_max_bypoint_avg.s + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_max_scaled_dissim_scaled_mod) #insignificant relationship

```

####Seas sst scaled
```{r seas sst scaled and dissim scaled}
#for all regions
dissimilarity_BC_balanced_sst_seas_scaled_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seas_scaled_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seas_scaled_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_seas_scaled_dissim_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_seas_bypoint_avg.s + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_seas_scaled_dissim_scaled_mod) #insignificant relationship

```
###Standard deviation of grid cells
####Mean temperature SD scaled
```{r mean sst SD scaled and dissim scaled}
#for all regions
dissimilarity_BC_balanced_sst_meanSD_scaled_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Mean surface temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_mean_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_meanSD_scaled_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_meanSD_scaled_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_meanSD_scaled_dissim_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_mean_bypoint_SD.s + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_meanSD_scaled_dissim_scaled_mod) #insignificant relationship
```

####Min temperature SD scaled
```{r min sst SD scaled and dissim scaled}
#for all regions
dissimilarity_BC_balanced_sst_minSD_scaled_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Min surface temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_min_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_minSD_scaled_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_minSD_scaled_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_minSD_scaled_dissim_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_min_bypoint_SD.s + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_minSD_scaled_dissim_scaled_mod) #insignificant relationship
```

####Max sst SD scaled
```{r max sst SD scaled and dissim scaled}
#for all regions
dissimilarity_BC_balanced_sst_maxSD_scaled_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Max surface temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_max_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_maxSD_scaled_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_maxSD_scaled_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_maxSD_scaled_dissim_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_max_bypoint_SD.s + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_maxSD_scaled_dissim_scaled_mod) #significant relationship

```

####Seas sst SD scaled
```{r seas sst SD scaled and dissim scaled}
#for all regions
dissimilarity_BC_balanced_sst_seasSD_scaled_dissim_scaled <- ggplot(data = dissimilarities_temp) +
  labs(x = "Seasonality of surface temperature SD scaled (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s, color = survey_unit), stat="smooth", method = "lm") +
  scale_color_manual(values = c(palette_37)) +
  geom_smooth(aes(x = yearly_seas_bypoint_SD.s, y = bray_curtis_dissimilarity_balanced_mean.s), method = "lm", se = F, color  = "black") +
  theme_classic()

ggsave(dissimilarity_BC_balanced_sst_seasSD_scaled_dissim_scaled, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_seasSD_scaled_dissim_scaled.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_seasSD_scaled_dissim_scaled_mod <- lmer(bray_curtis_dissimilarity_balanced_mean.s ~ yearly_seas_bypoint_SD.s + (1|survey_unit), data = dissimilarities_temp)

summary(dissimilarity_BC_balanced_sst_seasSD_scaled_dissim_scaled_mod) #insignificant relationship

```



###Comparing scaled temperature predictors
```{r compare scaled temp predictors with scaled dissim}

#list of models
list_scaled_dissim_scaled_mods <- grep("*_scaled_dissim_scaled_mod",names(.GlobalEnv),value=TRUE)

scaled_dissim_scaled_mods_AICc <- AICc(dissimilarity_BC_balanced_sst_maxSD_scaled_dissim_scaled_mod , dissimilarity_BC_balanced_sst_meanSD_scaled_dissim_scaled_mod,
dissimilarity_BC_balanced_sst_max_scaled_dissim_scaled_mod  ,  dissimilarity_BC_balanced_sst_minSD_scaled_dissim_scaled_mod, 
dissimilarity_BC_balanced_sst_seas_scaled_dissim_scaled_mod ,  dissimilarity_BC_balanced_sst_seasSD_scaled_dissim_scaled_mod,
dissimilarity_BC_balanced_sst_min_scaled_dissim_scaled_mod  ,  dissimilarity_BC_balanced_sst_mean_scaled_dissim_scaled_mod) #compare all scaled_mods

#best mods (all within 2 AICc): 
r.squaredGLMM(dissimilarity_BC_balanced_sst_min_scaled_dissim_scaled_mod)
summary(dissimilarity_BC_balanced_sst_min_scaled_dissim_scaled_mod) #p = 0.06
r.squaredGLMM(dissimilarity_BC_balanced_sst_mean_scaled_dissim_scaled_mod)
summary(dissimilarity_BC_balanced_sst_mean_scaled_dissim_scaled_mod)# 0.09
r.squaredGLMM(dissimilarity_BC_balanced_sst_maxSD_scaled_dissim_scaled_mod)
summary(dissimilarity_BC_balanced_sst_maxSD_scaled_dissim_scaled_mod) # p = 0.168




#for all temp mods, almost nothing is described by scaled temp in region (0.05% of variation), most described by survey unit (90% of variation)
```

####What to carry forward:
Best models
```{r}
balanced_dissimilarity_sst_model_results #NOT SURE ABOUT DF

saveRDS(balanced_dissimilarity_sst_model_results, here::here("output","balanced_dissimilarity_sst_model_results.rds"))
```

For both scaled and unscaled, mean temp is the best predictor.

####Finally, plot two best models
Raw: dissimilarity_BC_balanced_sst_mean_mod
```{r}
dissimilarities_temp.nona <- na.omit(dissimilarities_temp)

dissimilarities_temp.nona$pred_mean_sst <- predict(dissimilarity_BC_balanced_sst_mean_mod,re.form=NA)  ## population level
dissimilarities_temp.nona$pred_mean_sst_individual <- predict(dissimilarity_BC_balanced_sst_mean_mod) ## individual level

#confidence intervals
confit <- confint(dissimilarity_BC_balanced_sst_mean_scaled_mod, oldNames = F)

#upper lower bounds from confidence intervals
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_lwr := confit[5,1] + confit[6,1]*yearly_mean_bypoint_avg]#lower confidence interval
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_upr := confit[5,2] + confit[6,2]*yearly_mean_bypoint_avg]#upper confidence interval


#for all regions
(dissimilarity_BC_balanced_sst_mean.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = as.numeric(yearly_mean_bypoint_avg), y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = as.numeric(yearly_mean_bypoint_avg), y = pred_mean_sst_individual, color = survey_unit)) +
  scale_color_manual(values = c(palette_37)) +
  geom_line(aes(x = as.numeric(yearly_mean_bypoint_avg), y = pred_mean_sst), color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_mean.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean.final.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_mean_facet.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean surface temperature (˚C)",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = pred_mean_sst_individual, color = survey_unit)) +
  scale_color_manual(values = c(palette_37)) +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic() +
  theme(legend.position = "null")


ggsave(dissimilarity_BC_balanced_sst_mean_facet.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean_facet.final.jpg", height = 10, width = 16, unit = "in")

#simplified color scheme
(dissimilarity_BC_balanced_sst_mean.finalSIMPLIFIED <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Mean surface temperature (˚C)",  y = "Dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.4) +
  geom_line(aes(x = yearly_mean_bypoint_avg, y = pred_mean_sst), color  = "black") +
    geom_ribbon(aes(x = yearly_mean_bypoint_avg, ymin = pred_mean_temp_scale_byreg_lwr, ymax = pred_mean_temp_scale_byreg_upr), alpha = 0.3) +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_mean.finalSIMPLIFIED, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean.finalSIMPLIFIED.jpg", height = 4, width = 9, unit = "in") 
```


Plot just dissimilarity ~ raw temp coefficients of each region (Like figure 1b)
```{r plot raw temp sst coefficients}

#unique survey unit year combos
survey_unit_sampling_years <- unique(region_stats[,.(survey_unit, years_sampled)]) #unique survey unit year combos
                                    


 # see group coefficients and confidence intervals
surface_temp_model_coefs_reduced <- data.table(transform(as.data.frame(ranef(dissimilarity_BC_balanced_sst_mean_mod)), lwr = condval - 1.96*condsd, upr = condval + 1.96*condsd))
#https://stackoverflow.com/questions/69805532/extract-the-confidence-intervals-of-lmer-random-effects-plotted-with-dotplotra


#ONLY SLOPES
surface_temp_model_coefs_reduced <- surface_temp_model_coefs_reduced[term == "yearly_mean_bypoint_avg",]

surface_temp_model_coefs_reduced[,survey_unit := grp][,yearly_mean_bypoint_avg := condval]

#merge with duration of survey
surface_temp_model_coefs_reduced_length <- surface_temp_model_coefs_reduced[survey_unit_sampling_years, on = "survey_unit"]


surface_temp_model_coefs_reduced_length[,years_sampled := as.numeric(years_sampled)][,Slope_Direction := ifelse(yearly_mean_bypoint_avg > 0, "Positive","Negative")]

#
surface_temp_model_coefs_reduced_length <- surface_temp_model_coefs_reduced_length[color_link, on = "survey_unit"]


#does it cross zero?
surface_temp_model_coefs_reduced_length[,significant := ifelse(lwr >0 & upr>0,T,ifelse(lwr<0 & upr<0,T,F))]

#delete all obs that are significant
surface_temp_model_coefs_reduced_length.r <- surface_temp_model_coefs_reduced_length[significant == F,]

#order table by coefficient
setorder(surface_temp_model_coefs_reduced_length, yearly_mean_bypoint_avg)

BC_balanced_surface_temp_model_coefs_reduced_length.unique <- unique(surface_temp_model_coefs_reduced_length[,.(condval,condsd, lwr, upr, survey_unit, yearly_mean_bypoint_avg, years_sampled, Slope_Direction, hex, Survey_Name_Season, significant)]) 

#extract color hexes
#year adj coef order
color_year_adj_order <-BC_balanced_surface_temp_model_coefs_reduced_length.unique[,hex]

#alphabetical order
BC_balanced_surface_temp_model_coefs_reduced_length.unique.alpha <- setorder(BC_balanced_surface_temp_model_coefs_reduced_length.unique, Survey_Name_Season)
color_alpha_order <- BC_balanced_surface_temp_model_coefs_reduced_length.unique.alpha[,hex]

saveRDS(BC_balanced_surface_temp_model_coefs_reduced_length.unique, here::here("output","region_stats","BC_balanced_surface_temp_model_coefs_reduced_length.unique.Rds"))
```

Bar Plot Coefficient Scaled Bottom Temperature LMER
```{r bar plot of scaled surface temperature coefficients}
BC_BALANCED_Dissimilarity_Coef_SURFACETEMP_errorbar_reduced <- ggplot() +
    geom_errorbar(data = surface_temp_model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, yearly_mean_bypoint_avg) , y = yearly_mean_bypoint_avg, label = Survey_Name_Season, ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(data = surface_temp_model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, yearly_mean_bypoint_avg) , y = yearly_mean_bypoint_avg, label = Survey_Name_Season, 
        #size = years_sampled,
        fill = Slope_Direction), stat = 'identity', shape = 21, color = "black") +
  scale_fill_manual(values = c("white","black"), name = "Slope Direction") +
  geom_point(data = surface_temp_model_coefs_reduced_length.r, aes(x = reorder(Survey_Name_Season, yearly_mean_bypoint_avg) , y = yearly_mean_bypoint_avg, 
     # size = years_sampled, 
      label = Survey_Name_Season), stat = 'identity', fill = "grey",color = "grey", shape = 21) +
 # scale_size_binned(range = c(1,8), name = "Survey period\nlength") +
  geom_hline(yintercept = 0) +
  xlab("Survey unit") +
  ylab("Balanced BC dissimilarity ~\nraw surface temperature") +
  coord_flip() +
  theme_classic()

#+
#  theme(axis.text.y = element_text(colour = color_yearly_mean_bypoint_avg_order, face = "bold"), axis.title.y = element_blank())

BC_BALANCED_Dissimilarity_Coef_SURFACETEMP_errorbar_reduced

#save as independent grob to merge with fishing
saveRDS(BC_BALANCED_Dissimilarity_Coef_SURFACETEMP_errorbar_reduced, here::here("figures","BC_BALANCED_Dissimilarity_Coef_SURFACETEMP_errorbar_reduced.Rds"))
```


Scaled: dissimilarity_BC_balanced_sst_mean_scaled_mod
```{r}
dissimilarities_temp.nona$pred_mean_sst.s <- predict(dissimilarity_BC_balanced_sst_mean_scaled_mod,re.form=NA)  ## population level
dissimilarities_temp.nona$pred_mean_sst_individual.s <- predict(dissimilarity_BC_balanced_sst_mean_scaled_mod) ## individual level


#confidence intervals
confit <- confint(dissimilarity_BC_balanced_sst_mean_scaled_mod, oldNames = F)

#upper lower bounds from confidence intervals
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_lwr := confit[5,1] + confit[6,1]*yearly_mean_bypoint_avg.s]#lower confidence interval
dissimilarities_temp.nona[,pred_mean_temp_scale_byreg_upr := confit[5,2] + confit[6,2]*yearly_mean_bypoint_avg.s]#upper confidence interval

#for all regions
(dissimilarity_BC_balanced_sst_mean.s.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Relative mean surface temperature",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = pred_mean_sst_individual.s, color = survey_unit)) +
  scale_color_manual(values = c(palette_37)) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = pred_mean_sst.s), color  = "black") +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_mean.s.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean.s.final.jpg", height = 4, width = 9, unit = "in") 

dissimilarity_BC_balanced_sst_mean_facet.s.final <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Relative mean surface temperature",  y = "Bray Curtis balanced dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean, color = survey_unit), alpha = 0.3) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = pred_mean_sst_individual.s, color = survey_unit)) +
  scale_color_manual(values = c(palette_37)) +
  facet_wrap(~survey_unit, scales = "free") +
  theme_classic() +
  theme(legend.position = "null")

ggsave(dissimilarity_BC_balanced_sst_mean_facet.s.final, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean_facet.s.final.jpg", height = 10, width = 16, unit = "in")

#simplified color scheme
(dissimilarity_BC_balanced_sst_mean.s.final.SIMPLIFIED <- ggplot(data = dissimilarities_temp.nona) +
  labs(x = "Relative mean surface temperature",  y = "Dissimilarity") +
  geom_point(aes(x = yearly_mean_bypoint_avg.s, y = bray_curtis_dissimilarity_balanced_mean), alpha = 0.4) +
  geom_line(aes(x = yearly_mean_bypoint_avg.s, y = pred_mean_sst.s), color  = "black") +
    geom_ribbon(aes(x = yearly_mean_bypoint_avg.s, ymin = pred_mean_temp_scale_byreg_lwr, ymax = pred_mean_temp_scale_byreg_upr), alpha = 0.3) +
  theme_classic())

ggsave(dissimilarity_BC_balanced_sst_mean.s.final.SIMPLIFIED, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean.s.final.SIMPLIFIED.jpg", height = 4, width = 9, unit = "in") 
```

Plot just dissimilarity ~ scaled temp coefficients of each region (Like figure 1b)
```{r}

 # see group coefficients and confidence intervals
surface_temp_scaled_model_coefs_reduced <- data.table(transform(as.data.frame(ranef(dissimilarity_BC_balanced_sst_mean_scaled_mod)), lwr = condval - 1.96*condsd, upr = condval + 1.96*condsd))
#https://stackoverflow.com/questions/69805532/extract-the-confidence-intervals-of-lmer-random-effects-plotted-with-dotplotra


#ONLY SLOPES
surface_temp_scaled_model_coefs_reduced <- surface_temp_scaled_model_coefs_reduced[term == "yearly_mean_bypoint_avg.s",]

surface_temp_scaled_model_coefs_reduced[,survey_unit := grp][,yearly_mean_bypoint_avg.s := condval]

#merge with duration of survey
surface_temp_scaled_model_coefs_reduced_length <- surface_temp_scaled_model_coefs_reduced[survey_unit_sampling_years, on = "survey_unit"]


surface_temp_scaled_model_coefs_reduced_length[,years_sampled := as.numeric(years_sampled)][,Slope_Direction := ifelse(yearly_mean_bypoint_avg.s > 0, "Positive","Negative")]

#
surface_temp_scaled_model_coefs_reduced_length <- surface_temp_scaled_model_coefs_reduced_length[color_link, on = "survey_unit"]


#does it cross zero?
surface_temp_scaled_model_coefs_reduced_length[,significant := ifelse(lwr >0 & upr>0,T,ifelse(lwr<0 & upr<0,T,F))]

#delete all obs that are significant
surface_temp_scaled_model_coefs_reduced_length.r <- surface_temp_scaled_model_coefs_reduced_length[significant == F,]

#order table by coefficient
setorder(surface_temp_scaled_model_coefs_reduced_length, yearly_mean_bypoint_avg.s)

BC_balanced_surface_temp_scaled_model_coefs_reduced_length.unique <- unique(surface_temp_scaled_model_coefs_reduced_length[,.(condval,condsd, lwr, upr, survey_unit, yearly_mean_bypoint_avg.s, years_sampled, Slope_Direction, hex, Survey_Name_Season, significant)]) 

#extract color hexes
#year adj coef order
color_year_adj_order <-BC_balanced_surface_temp_scaled_model_coefs_reduced_length.unique[,hex]

#alphabetical order
BC_balanced_surface_temp_scaled_model_coefs_reduced_length.unique.alpha <- setorder(BC_balanced_surface_temp_scaled_model_coefs_reduced_length.unique, Survey_Name_Season)
color_alpha_order <- BC_balanced_surface_temp_scaled_model_coefs_reduced_length.unique.alpha[,hex]

saveRDS(BC_balanced_surface_temp_scaled_model_coefs_reduced_length.unique, here::here("output","region_stats","BC_balanced_surface_temp_scaled_model_coefs_reduced_length.unique.Rds"))
```

Bar Plot Coefficient Scaled Bottom Temperature LMER
```{r bar plot of scaled surface temperature coefficients}
BC_BALANCED_Dissimilarity_Coef_scaled_SURFACETEMP_errorbar_reduced <- ggplot() +
    geom_errorbar(data = surface_temp_scaled_model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, yearly_mean_bypoint_avg.s) , y = yearly_mean_bypoint_avg.s, label = Survey_Name_Season, ymin = lwr, ymax = upr), fill = "grey", width = 0) + #add confidence intervals
  geom_point(data = surface_temp_scaled_model_coefs_reduced_length, aes(x = reorder(Survey_Name_Season, yearly_mean_bypoint_avg.s) , y = yearly_mean_bypoint_avg.s, label = Survey_Name_Season,
      #size = years_sampled,
      fill = Slope_Direction), stat = 'identity', shape = 21, color = "black") +
  scale_fill_manual(values = c("white","black"), name = "Slope Direction") +
  geom_point(data = surface_temp_scaled_model_coefs_reduced_length.r, aes(x = reorder(Survey_Name_Season, yearly_mean_bypoint_avg.s) , y = yearly_mean_bypoint_avg.s, 
       # size = years_sampled,
        label = Survey_Name_Season), stat = 'identity', fill = "grey",color = "grey", shape = 21) +
 # scale_size_binned(range = c(1,8), name = "Survey period\nlength") +
  geom_hline(yintercept = 0) +
  xlab("Survey unit") +
  ylab("Balanced BC dissimilarity ~\nrelative surface temperature") +
  coord_flip() +
  theme_classic()

#+
#  theme(axis.text.y = element_text(colour = color_yearly_mean_bypoint_avg.s_order, face = "bold"), axis.title.y = element_blank())

BC_BALANCED_Dissimilarity_Coef_scaled_SURFACETEMP_errorbar_reduced

#save as independent grob to merge with fishing
saveRDS(BC_BALANCED_Dissimilarity_Coef_scaled_SURFACETEMP_errorbar_reduced, here::here("figures","BC_BALANCED_Dissimilarity_Coef_scaled_SURFACETEMP_errorbar_reduced.Rds"))
```

Merge lollipops
```{r}
BC_BALANCED_Dissimilarity_Coef_SURFACETEMP_errorbar_reduced_merge <- cowplot::plot_grid(BC_BALANCED_Dissimilarity_Coef_SURFACETEMP_errorbar_reduced + theme(legend.position = "null", axis.title.y = element_blank()), BC_BALANCED_Dissimilarity_Coef_scaled_SURFACETEMP_errorbar_reduced + theme(legend.position = "null", axis.title.y = element_blank()), cowplot::get_legend(BC_BALANCED_Dissimilarity_Coef_scaled_SURFACETEMP_errorbar_reduced), nrow = 1, ncol = 3, rel_widths = c(1,1,0.2), rel_heights = c(1,1,0.2))

ggsave(BC_BALANCED_Dissimilarity_Coef_SURFACETEMP_errorbar_reduced_merge, path = "figures", filename = "BC_BALANCED_Dissimilarity_Coef_SURFACETEMP_errorbar_reduced_merge.jpg", height = 5, width = 12, units = "in")
```



###Merge
```{r}
library(cowplot)
(dissimilarity_BC_balanced_sst_mean.final.SIMPLIFIED_merge <- plot_grid(dissimilarity_BC_balanced_sst_mean.finalSIMPLIFIED, dissimilarity_BC_balanced_sst_mean.s.final.SIMPLIFIED + theme(axis.title.y = element_blank(), axis.text.y = element_blank()), nrow = 1, ncol = 2, labels = c("a.","b."), hjust = -1))

ggsave(dissimilarity_BC_balanced_sst_mean.final.SIMPLIFIED_merge, path  = here::here("figures","predictor_variables"), filename = "dissimilarity_BC_balanced_sst_mean.final.SIMPLIFIED_merge.jpg", height = 4, width = 9, unit = "in") 
```

