---
title: "Regional Statistics"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r setup}
library(data.table)
library(ggplot2)
library(sf)
library(rgeos)
library(concaveman)
library(raster)


FishGlob_cleaned.10year <- readRDS(here::here("output","region_season_cleaned_data","FishGlob_cleaned.10year.rds"))

#change depth to numeric
FishGlob_cleaned.10year[,depth := as.numeric(depth)]
```

Pull in avg temp values and pull in avg fishing values
```{r}
 #open fishing and temp data
distances_dissimilarities_allyears.year.models.temp.fishing <- readRDS( here::here("output","distance_decay","distances_dissimilarities_allyears.year.models.temp.fishing.rds"))

distances_dissimilarities_allyears.year.models.temp.fishing[,mean_reg_temp_allyears := mean(sst_mean, na.rm = T),.(survey,season)][,mean_reg_fishing_allyears := mean(summed_tonnes, na.rm = T),.(survey,season,bray_coef, bray_coef_pvalue, jaccard_coef, jaccard_coef_pvalue)]


distances_dissimilarities_allyears.year.models.temp.fishing.r <- unique(distances_dissimilarities_allyears.year.models.temp.fishing[,.(survey, season,mean_reg_fishing_allyears, mean_reg_temp_allyears, bray_coef, bray_coef_pvalue, jaccard_coef, jaccard_coef_pvalue)]) #for some reason Nor-BTS and S-GEORG are not registering anything, check on these later for fishing landing data

#add back survey season row
distances_dissimilarities_allyears.year.models.temp.fishing.r[,survey_season := paste0(survey,"_",season)]
```


```{r calculate all region stats}

#survey_seasons_list
survey_seasons <- distances_dissimilarities_allyears.year.models.temp.fishing.r[,survey_season]

region_stats <- as.data.table(matrix(nrow = length(survey_seasons)))

region_stats[,survey_season := as.character(V1)][, survey := as.character(V1)][ , season := as.character(V1)][, spp_num := as.numeric(V1)][, study_period := as.numeric(V1)][, study_duration := as.numeric(V1)][, lat_range := as.numeric(V1)][, mid_lat := as.numeric(V1)][, lon_range := as.numeric(V1)][, area := as.numeric(V1)][, depth_range := as.numeric(V1)][,  mid_depth := as.numeric(V1)][, mean_temp := as.numeric(V1)][, mean_landings := as.numeric(V1)][,jaccard_coef := as.numeric()][,bray_coef := as.numeric()]

  region_stats[,V1:=NULL]

for (i in 1:length(survey_seasons)) {
  reduced_FishGlob_cleaned.10year <- FishGlob_cleaned.10year[survey_season == survey_seasons[i]]
  
  reduced_distances_dissimilarities_allyears.year.models.temp.fishing.r <- distances_dissimilarities_allyears.year.models.temp.fishing.r[survey_season == survey_seasons[i]]
    ####unique lat lon
    lat_lon <- unique(reduced_FishGlob_cleaned.10year[,.(latitude, longitude)])
    
    pts <- st_as_sf(lat_lon, coords=c('longitude','latitude'), crs=4326 )
    
    conc <- concaveman(pts)
    
    sf_use_s2(FALSE) #helps with spherical geometry
    area <- st_area(conc) #m2

    #compile into region_Stats table    
                  region_stats[i,"survey_season"] <- paste0(survey_seasons[i])
                  region_stats[i,"survey"] <- word(survey_seasons[i],1, sep = "_")
                  region_stats[i,"season"] <- word(survey_seasons[i],2, sep = "_")
                  region_stats[i,"spp_num"] <- length(unique(reduced_FishGlob_cleaned.10year[,accepted_name]))
                  region_stats[i,"study_period"] <- max(reduced_FishGlob_cleaned.10year$year)-min(reduced_FishGlob_cleaned.10year$year)
                  region_stats[i,"study_duration"] <- length(unique(reduced_FishGlob_cleaned.10year$year))
                  region_stats[i,"lat_range"] <- max(reduced_FishGlob_cleaned.10year$latitude)-min(reduced_FishGlob_cleaned.10year$latitude)
                  region_stats[i,"mid_lat"] <- mean(reduced_FishGlob_cleaned.10year$latitude)
                  region_stats[i,"lon_range"] <- max(reduced_FishGlob_cleaned.10year$longitude)-min(reduced_FishGlob_cleaned.10year$longitude)
                  region_stats[i,"area"] <- area
                  region_stats[i,"depth_range"] <- max(reduced_FishGlob_cleaned.10year$depth, na.rm = T)-min(reduced_FishGlob_cleaned.10year$depth, na.rm = T)
                  region_stats[i,"mid_depth"] <- mean(reduced_FishGlob_cleaned.10year$depth, na.rm = T)
                  region_stats[i,"mean_temp"] <- mean(reduced_distances_dissimilarities_allyears.year.models.temp.fishing.r[,mean_reg_temp_allyears])
                  region_stats[i,"mean_landings"] <- mean(reduced_distances_dissimilarities_allyears.year.models.temp.fishing.r[,mean_reg_fishing_allyears])
                  region_stats[i,"jaccard_coef"] <- ifelse(reduced_distances_dissimilarities_allyears.year.models.temp.fishing.r[,jaccard_coef_pvalue]<= 0.05,reduced_distances_dissimilarities_allyears.year.models.temp.fishing.r[,jaccard_coef], NA)
                  region_stats[i,"bray_coef"] <- ifelse(reduced_distances_dissimilarities_allyears.year.models.temp.fishing.r[,bray_coef_pvalue]<= 0.05,reduced_distances_dissimilarities_allyears.year.models.temp.fishing.r[,bray_coef], NA)
}
  
#if any values are -Inf, change to NA
invisible(lapply(names(region_stats),function(.name) set(region_stats, which(is.infinite(region_stats[[.name]])), j = .name,value =NA)))

region_stats[,bray_positive_negative_coef := ifelse(bray_coef >0, 1, -1)]
region_stats[,jaccard_positive_negative_coef := ifelse(jaccard_coef >0, 1, -1)]


saveRDS(region_stats, here::here("output","region_stats","region_stats.rds"))
```

PCA
```{r pca region stats}
library(factoextra)
region_stats.naomit <- na.omit(region_stats, cols = c(4:14))
region_stats.region_stats.descriptive<- data.frame(region_stats[,4:14])
rownames(region_stats.descriptive) <- region_stats$survey_season
region_stats.pca <- prcomp(na.omit(region_stats.descriptive), center = TRUE,scale. = TRUE) #removes all rows with missing values

fviz_pca_ind(region_stats.pca,
             repel = TRUE     # Avoid text overlapping
             )

fviz_pca_biplot(region_stats.pca, repel = TRUE,
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
                )

summary(region_stats.pca)

load.pca <- region_stats.pca$loadings
print(load.pca)

fviz_pca_var(region_stats.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,     # Avoid text overlapping
             geom = c("arrow", "text")
             )

fviz_pca(region_stats.pca, label = c("var","ind"), repel = T, habillage = region_stats.naomit[,survey_season], ggtheme = theme_classic())

fviz_pca(region_stats.pca, label = c("var","ind"), repel = T, habillage = region_stats.naomit[,jaccard_positive_negative_coef], ggtheme = theme_classic())

fviz_pca(region_stats.pca, label = c("ind"), repel = T, habillage = region_stats.naomit[,bray_positive_negative_coef], ggtheme = theme_classic())

fviz_pca(region_stats.pca, label = c("var"), repel = T, habillage = region_stats.naomit[,bray_positive_negative_coef], ggtheme = theme_classic())

fviz_pca(region_stats.pca, label = c("var","ind"), repel = T, habillage = region_stats.naomit[,bray_positive_negative_coef], ggtheme = theme_classic())
```

