---
title: "Spatial Turnover Exploratory Analysis"
output: html_notebook
---

Instructions from Malin:

Is anyone up for an exploratory analysis with the trawl data? It would be very cool to look at changes in spatial turnover, similar to [Magurran, Dornelas, Moyes, Gotelli, McGill et al. 2015](http://www.nature.com/ncomms/2015/150924/ncomms9405/full/ncomms9405.html) but across a much wider set of regions. An idea from conversations at [HIFMB](https://hifmb.de/en/) yesterday. 

From Magurran et al. *"Here, we analyse an exceptionally comprehensive 29-year time series of North Atlantic groundfish assemblages monitored over 5° latitude to the west of Scotland. These fish assemblages show no systematic change in species richness through time, but steady change in species composition, leading to an increase in spatial homogenization: the species identity of colder northern localities increasingly resembles that of warmer southern localities."*

Steps would be:

1. Calculate Jacard similarity between each haul in a single year in a single region. The vegdist() function in the vegan package would do this,OceanAdapt should have the data you’d need 
https://github.com/pinskylab/OceanAdapt/tree/master/data_raw for NEUS files

1. Calculate geographic distance between each haul in km (e.g., geosphere package in R could work).
1. Plot similarity vs. geographic distance and fit a regression line.
1. Repeat for each year.

A good place to start would just be the Northeast US. We could take a look and then think about expanding out to the other regions and to European data.

Methods from Magurran et al. 

First assign the rectangles to nine 30' latitudinal bands
Compile community time series for each latitudinal band
Sample rarefaction ensures equal sampling effort across bands and is used in the calculation of temporal $\alpha$ diversity and temporal $\beta$ diversity. 
First calculate similarity in relation to the start of the survey
Next, for each year, we compute pairwise compositional similarity of these latitudinal bands
We also construct distance-decay plots for each year

```{r setup}
library(data.table)
library(vegan)
```


```{r import all data from Ocean Adapt}
neus_strata <- read.csv("neus_strata.csv")
save(neus_strata, file = "neus_strata.RData")

load("neus_strata.Rdata")
load("neus_Survdat.RData")
load("neus_SVSPP.RData")

```

```{r extract columns we need from each}
neus_strata.r <- data.table(neus_strata[,c(2:3,5:6)])
neus_survdat.r <- data.table(survdat[,c(3,5,6,8,9)])
neus_spp.r <- data.table(spp[,c(1,2,4)])
```

```{r link data tables together}
stratamerge <- neus_survdat.r[neus_strata.r, on = "STRATUM"]
neus_full <- stratamerge[neus_spp.r, on = "SVSPP"]
neus_full
```

Make sure every observation is of an identifiable fish, aka SVSPP != 0

```{r ID fish}
neus_full.ID <- neus_full[SVSPP != 0,]
```

Group Stratums

For now, I will split into MAB, SNE, GB, and GOM

From Michelle's metadata:

Stratum group code: 
01 = Trawl, offshore north of Hatteras; 
03 = Trawl, inshore north of Hatteras; 
05 = Scotian shelf; 
07 = Trawl, inshore south of Hatteras; 
08 = Trawl, Offshore south of Hatteras;

#we only want 01 and 03's 

```{r only offshore and inshore north of hatteras}
neus_full.ID.0103 <- neus_full.ID[STRATUM < 4000]
```
I have trawls beginning with 1, 3, 5, 7, 8

MAB : 
  Offshore: 50:57, 61:66, 69:76 --> 1500:1570, 1610:1660, 1690:1760
  Inshore: 15:44, 50:58 --> 3150:3440, 3500:3580
  
```{r MAB}
MAB_dt <- data.table("STRATUM" = c(1500:1570, 1610:1660, 1690:1760, 3150:3440, 3500:3580), "reg" = "MAB")
```
  
SNE : 
  Offshore: 1:12 --> 1010:1200 
  Inshore: 1:14, 91 & 49 = LIS, 45:48, 50:55 --> 3010:3140, 3910, 3490, 3450:3480, 3500:3550
  
```{r SNE}
SNE_dt <- data.table("STRATUM" = c(1010:1200,3010:3140, 3910, 3490, 3450:3480, 3500:3550), "reg" = "SNE")
```
  
GB : 
  Offshore: 13:22 --> 1130:1220 
  Inshore: NA
```{r GB}
GB_dt <- data.table("STRATUM" = c(1130:1220), "reg" = "GB")
```
  
GOM : 
  Offshore: 23:34, 36:40 --> 1230:1340, 1360:1400
  Inshore: 56:90 --> 3560:3900
  
```{r GOM}
GOM_dt <- data.table("STRATUM" = c(1230:1340, 1360:1400,3560:3900), "reg" = "GOM")

```
Region Stratum Key
```{r region stratum key}
region_strata_key <- rbind(GOM_dt, GB_dt, SNE_dt, MAB_dt)
```

```{r link key to neus trawls}
neus_full.ID.0103[,"STRATUM_reg" := substr(STRATUM_NAME, 1, 3)]#extract first three letters from string of stratum name

setkey(neus_full.ID.0103, STRATUM)
setkey(region_strata_key, STRATUM)
neus_full.ID.regions <- neus_full.ID.0103[region_strata_key]


names <- data.frame(levels(neus_full.ID$STRATUM_NAME))
summary(neus_full.ID.0103$STRATUM_NAME)
```
