---
title: "Prepping EBS Data"
output: html_notebook
---


```{r setup}
library(dggridR)
library(data.table)
library(rgdal)
library(raster)
library(sp)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(taxize) #standardizing names
library(geosphere)  #to calculate distance between lat lon of grid cells
```


Very confused of how to pull in data right now. To keep it easy, I'll use cleaned Ocean Adapt data

https://github.com/pinskylab/OceanAdapt/tree/update_2019/data_clean/by_species.RData

December 1, 2020
```{r pull in data all regions}
dat_exploded <- readRDS("~/Documents/grad school/Rutgers/Repositories/trawl_spatial_turnover/dat_exploded.rds")
```

In the Eastern Bering Sea, sampling years prior to 1984 (data begin in 1982) were excluded from analysis due to large apparent increases in the number of species recorded in the first two years. 

```{r EBS}
dat_EBS <- dat_exploded[region == "Eastern Bering Sea",][year >= 1984,]

saveRDS(dat_EBS, "dat_EBS.RData")
rm(dat_exploded)
dat_EBS <- readRDS("dat_EBS.RData")
```


```{r pull in EBS}

# Get Unique lines in the data table
unique_EBS_latlon<- unique(dat_EBS[,.(lat, lon)])
unique_EBS_latlon.sf <- unique_EBS_latlon
  
#make lat lon coordinates into polygon
coordinates(unique_EBS_latlon.sf) <- ~lat + lon
unique_EBS_latlon.sf@proj4string <- crs("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

saveRDS(unique_EBS_latlon, "unique_EBS_latlon.RData")

#plot north america
world <- ne_countries(scale = "medium", returnclass = "sp")

world_ext <- extent(-180, -51.5,23, 67)

north_america_spdf <- crop(world, world_ext)

north_america_df <- fortify(north_america_spdf)

(na_outline <- ggplot(north_america_df, aes(long, lat, group = group)) +
  geom_polygon(color = "white", fill = "grey") +
  labs(x = "Longitude", y = "Latitude") +
  coord_equal() +
  theme_classic() +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1)) +
 geom_point(unique_EBS_latlon, mapping = aes(lon, lat), inherit.aes = FALSE, shape = 18, size = 0.001, color = "red") +
  coord_equal())

```

Playing around with dggridR (package that makes grid cells)
```{r learning dggridR}
dggs <- dgconstruct(spacing = 111, metric = T, resround = 'nearest')

unique_EBS_latlon[,cell := dgGEO_to_SEQNUM(dggs, lon, lat)] #get corresponding grid cells for NEUS trawl

#centersof cells
EBS_cellcenters <- dgSEQNUM_to_GEO(dggs, unique_EBS_latlon[,cell])

#linking cell centers to unique_EBS_latlon
unique_EBS_latlon[,LON_CENTER := EBS_cellcenters$lon_deg][,LAT_CENTER := EBS_cellcenters$lat_deg]

#link centers back to main data table

dat_EBS <- merge(dat_EBS, unique_EBS_latlon, by = c("lat", "lon"))


#number of tows in each cell
towcount <- unique_EBS_latlon[, .N, by = cell]

#get the grid cell boundary for cells which had trawls
grid_ebs <- dgcellstogrid(dggs, unique_EBS_latlon[,cell], frame = T, wrapcells = F)

#update grid properties to include # of trawls in each cell
grid_ebs <- merge(grid, unique_EBS_latlon, by.x = "cell", by.y ="cell")

ggplot(data = grid_ebs, aes(x = long, y = lat.x, group = cell)) +
  geom_polygon() +
  coord_quickmap()

saveRDS(grid_ebs, "grid_ebs.RData")

```

Trying to plot with grid overlaying
```{r grid overlaying}

na_outline + 
   geom_polygon(grid, mapping = aes(x = long,y = lat.x, group = cell), inherit.aes = FALSE, color = "black", fill = NA, size = 0.1)

ggsave(filename = "grid_EBS_cells_spacing_111.pdf")
  
```
Cleaning spp names (must be ID'd to species!)
```{r clean ebs names}
#unique species names
spp_ebs <- dat_EBS[,unique(spp)]


#Using taxize package, I'm going to check and standardize species scientific names
result.long <- spp_ebs %>%
gnr_resolve(data_source_ids = c(9,155), #marine species and fisebase sources
            with_canonical_ranks=T)

result.long <- data.table(result.long)


result.short <- result.long[result.long[, .I[which.max(score)], by=.(user_supplied_name, matched_name2)]$V1][,spp := user_supplied_name]

#keep only rows with space in SCINAME column (signifying genus and species are identified)
result.short <- result.short[grep(" ", matched_name2),]

#merge cleaned species names with neus full 
dat_EBS.clean <- dat_EBS[result.short, on = "spp"]

```

Now, we'll overlay grid cells onto this list of tows (dat_EBS) using lat and lon and gridrr package
```{r get rid of underused grid cells}

year_grid <- data.table(table(dat_EBS$cell, dat_EBS$year))

#there are some grid cells with infrequent records, I will delete these
grid_cells_to_exclude <- unique(year_grid[N == 0]$V1)

#delete these grid cells from full data table
dat_EBS.reduced <- dat_EBS.clean[!cell %in% grid_cells_to_exclude]

#1456441 observations left, this should be great

#how many tows (TOW) per cell in a given year
colnames(dat_EBS.reduced)

haul_cell_unique <- unique(dat_EBS.reduced[,.(haulid, cell, year)])

EBS_samplingevents_byyear <- haul_cell_unique[,.N, .(year, cell)]

EBS_cells_lessthan3 <- EBS_samplingevents_byyear[N<3,]

cells_to_delete <- unique(EBS_cells_lessthan3[,cell])

dat_EBS.reduced.again <- dat_EBS.reduced[!cell %in% cells_to_delete]

#down to 1307600 observations


saveRDS(dat_EBS.reduced.again, "ebs_data_gridded.RData")
```

Find distance between center of each grid cell
```{r distance between grid cells}
#just need grid cell # and center lat lon for each grid cell 
EBS_grid_cells <- unique(dat_EBS.reduced.again[,.(cell, LON_CENTER, LAT_CENTER)])

EBS_grid_cells <- setorder(EBS_grid_cells, cell)

EBS_reg_distances <- distm(EBS_grid_cells[,.(LON_CENTER, LAT_CENTER)])

colnames(EBS_reg_distances) <- EBS_grid_cells$cell
rownames(EBS_reg_distances) <- EBS_grid_cells$cell

#reorient to long form 
EBS_reg_distances.l <- melt(as.matrix(EBS_reg_distances), varnames = c("cell1", "cell2"), value.name = "distance(m)") #matrix to data frame
EBS_reg_distances.l <- data.table(EBS_reg_distances.l) #and then to data table
EBS_reg_distances.l <- EBS_reg_distances.l[cell1 > cell2,] # get rid of repetitions and self-comparisons
saveRDS(EBS_reg_distances.l, "EBS_reg_distances.l.RData")

```